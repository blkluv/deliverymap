<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑客指南針</title>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- 移除舊的自動重新導向腳本 -->

    <!-- Script to clean URL parameters from Facebook, etc. -->
    <script>
        (function() {
            // This script runs immediately to clean the URL if necessary,
            // avoiding issues with reloads or sharing.
            const url = new URL(window.location);
            if (url.searchParams.has('fbclid')) {
                const newUrl = url.pathname + url.hash;
                window.history.replaceState({}, document.title, newUrl);
            }
        })();
    </script>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- NEW: Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    
    <!-- MODIFIED: pinyin-pro for Chinese to Pinyin conversion -->
    <script src="https://unpkg.com/pinyin-pro@3.18.2/dist/index.js"></script>


    <style>
        /* 自定義樣式 */
        :root {
            /* 手機版底部安全距離 (可調整此數值) */
            --mobile-bottom-offset: 6rem; 
            /* 手機版店家列表寬度 (可調整此數值) */
            --mobile-panel-width: 90vw;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overflow: hidden; /* 防止滾動 */
        }
        #map {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
        }
        /* OpenLayers 彈出視窗樣式 */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 300px;
            max-width: 350px;
            transform: translateX(-50%);
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 50%;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 50%;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 20px;
        }
        .ol-popup-closer:after {
            content: "✖";
        }
        /* 避免 Tailwind CSS 影響 OpenLayers 控制項 */
        .ol-control button {
            background-color: rgba(255,255,255,0.8) !important;
            color: #333 !important;
            border: 1px solid #ccc !important;
        }
        .ol-control button:hover {
            background-color: rgba(255,255,255,1) !important;
        }
        /* 滾動條樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #store-list-filters::-webkit-scrollbar {
            height: 9px; /* For horizontal scrollbar */
        }
        #store-list-filters::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }
        #store-list-filters::-webkit-scrollbar-track {
            background: #eee;
            border-radius: 4px;
        }
        /* 當前位置標記動畫 */
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        /* 新增地點的標記樣式 */
        .new-location-marker {
             width: 32px;
             height: 32px;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef4444" width="32px" height="32px"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>');
             background-size: contain;
             cursor: grab;
             transform: translate(-50%, -100%);
             z-index: 10;
        }
        .new-location-marker:active {
            cursor: grabbing;
        }
        /* NEW: Desktop Add Mode Layout */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #map-container {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }
        #add-location-modal.desktop-mode {
            position: relative;
            display: flex;
            width: 0px; /* Start with 0 width */
            max-width: 450px;
            height: 100%;
            transform: translateX(-100%);
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            z-index: 50;
            overflow: hidden;
        }
        #app-container.desktop-add-mode #add-location-modal.desktop-mode {
            width: 450px;
            transform: translateX(0);
        }
        
        #desktop-center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%); /* Adjust to pin bottom point to center */
            z-index: 10;
            pointer-events: none; /* Make it non-interactive */
        }

        /* Responsive positioning for bottom elements */
        #store-list-panel, #legend {
            bottom: 1rem; /* 桌面版的預設值 (Tailwind class: bottom-4) */
        }
        /* 在小於 768px 的螢幕上（手機版）套用較高的底部距離 */
        @media (max-width: 767px) {
            #legend {
                display: none; /* 在手機版上隱藏中間の分類圖例 */
            }
            #store-list-panel {
                bottom: var(--mobile-bottom-offset);
                width: var(--mobile-panel-width);
                max-width: 400px; /* 避免在較寬の手機螢幕上過寬 */
                left: 50%;
                transform: translateX(-50%);
            }
            #add-location-modal.desktop-mode {
                display: none; /* Hide desktop version on mobile */
            }
        }
        @media (min-width: 768px) {
            #add-location-modal:not(.desktop-mode) {
                display: none; /* Hide mobile modal on desktop */
            }
        }
        /* NEW: Vote button styles */
        .vote-btn.voted-like svg {
            fill: #10B981; /* A brighter green */
        }
        .vote-btn.voted-dislike svg {
            fill: #EF4444; /* A brighter red */
        }
        /* NEW: LINE Login Button Style */
        #line-login-btn {
            background-color: #00B900;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #line-login-btn:hover {
            background-color: #00A300;
        }
        #line-login-btn img {
            width: 24px;
            margin-right: 8px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="relative h-screen w-screen overflow-hidden">
        <!-- NEW: App Container for Desktop Layout -->
        <div id="app-container">
            <!-- 新增/編輯店家 Modal (Desktop Sidebar) -->
            <div id="add-location-modal" class="desktop-mode">
                <div class="bg-white shadow-2xl w-full h-full flex flex-col">
                    <form id="add-location-form" class="flex-grow flex flex-col overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                            <h2 id="modal-title" class="text-xl font-bold text-gray-800">新增地點</h2>
                            <div class="flex items-center space-x-2">
                                 <button id="submit-location-btn" type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center w-28">
                                    <span class="submit-text">送出審核</span>
                                    <span class="spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                                </button>
                                <button id="close-add-location-modal" type="button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                            </div>
                        </div>
                        <div class="px-6 pt-2 pb-16 space-y-4 overflow-y-auto custom-scrollbar flex-grow">
                            <input type="hidden" id="edit-row-index" name="rowIndex">
                            <input type="hidden" id="edit-original-name" name="originalName">
                            <p class="text-sm text-gray-600">請移動地圖中心點來選擇位置。</p>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">地址 <span class="text-red-500">*</span></label>
                                <div id="address-input-container">
                                    <input type="text" id="add-address" name="address" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">類別 <span class="text-red-500">*</span></label>
                                <select id="add-category" name="category" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" required></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">黑名類別 <span class="text-red-500">*</span></label>
                                <select id="add-blacklist-category" name="blacklistCategory" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                                    <option value="奧客">奧客</option>
                                    <option value="送上樓">送上樓</option>
                                    <option value="拖吊">拖吊</option>
                                    <option value="騙餐">騙餐</option>
                                    <option value="奇怪">奇怪</option>
                                    <option value="店家">店家</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">黑名原因 (最少3個中文字) <span class="text-red-500">*</span></label>
                                <textarea id="add-blacklist-reason" name="blacklistReason" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Map Container -->
            <main id="map-container" class="w-full h-full relative">
                <div id="map"></div>
                
                <!-- 錯誤/提示訊息 -->
                <div id="notification" class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-yellow-500 text-white text-sm py-2 px-4 rounded-lg shadow-lg hidden transition-all duration-300">
                    訊息
                </div>

                <!-- 彈出視窗容器 -->
                <div id="popup" class="ol-popup">
                    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                    <div id="popup-content"></div>
                </div>
                
                <!-- 當前位置標記 (HTML Overlay) -->
                <div id="user-location" class="absolute w-4 h-4 -translate-x-1/2 -translate-y-1/2 hidden">
                    <div class="w-full h-full rounded-full bg-blue-600 border-2 border-white shadow-md pulse-dot"></div>
                </div>
                
                <!-- NEW: Desktop center marker -->
                <div id="desktop-center-marker" class="hidden">
                     <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ef4444' width='40px' height='40px'><path d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/></svg>" alt="Center Marker">
                </div>

                <!-- UI 按鈕群組 -->
                <div class="absolute top-4 right-4 z-10 flex flex-col items-end space-y-2">
                    <!-- 登入/新增說明按鈕 -->
                    <div id="login-status">
                        <!-- NEW: Container for LINE Login Button -->
                        <div id="line-login-container" style="display: none;">
                            <button id="line-login-btn">
                                <img src="https://weibsite.github.io/deliverymap/btn_base.png" alt="LINE logo">
                                登入
                            </button>
                        </div>
                        <!-- Container for Google Login Button -->
                        <div id="google-signin-container" style="display: none;"></div>
                        
                         <div id="add-info" class="bg-white text-gray-700 py-2 px-4 rounded-lg shadow-lg items-center space-x-2 hidden">
                            <span id="user-name" class="font-bold"></span>
                            <button id="edit-nickname-btn" class="text-xs text-blue-500 hover:underline">[修改]</button>
                            <button id="manage-btn" class="text-sm text-blue-600 hover:underline">管理</button>
                            <button id="review-btn" class="text-sm text-red-600 hover:underline hidden">審核</button>
                            <a href="#" id="sign-out-btn" class="text-xs text-gray-500 hover:underline ml-2">登出</a>
                        </div>
                    </div>
                    <button id="open-filter-modal" class="bg-blue-600 text-white p-3 rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center" title="篩選">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                     <button id="center-on-me-btn" class="bg-white text-gray-700 p-3 rounded-lg shadow-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center" title="回到我的位置">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                    <button id="add-location-btn" class="bg-white text-gray-700 p-3 rounded-lg shadow-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center" title="新增店家">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>


                <!-- 圖例 -->
                <div id="legend" class="absolute left-1/2 -translate-x-1/2 z-10 bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-md">
                    <div id="legend-content" class="flex items-center justify-center flex-wrap gap-x-4 gap-y-1 text-xs md:text-sm">
                        <!-- 圖例內容將由 JS 動態生成 -->
                    </div>
                </div>
                
                <!-- 店家列表面板 -->
                <div id="store-list-panel" class="absolute left-4 w-64 z-10 bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-md flex flex-col transition-all duration-300 ease-in-out" style="max-height: 14rem;">
                    <div class="flex justify-between items-start flex-shrink-0 mb-2">
                        <div id="store-list-filters" class="flex-grow flex overflow-x-auto pb-1 custom-scrollbar">
                            <!-- 分類按鈕將由 JS 動態生成 -->
                        </div>
                        <button id="toggle-store-list-btn" class="flex-shrink-0 ml-2 p-1 -mr-1 rounded-full hover:bg-gray-200 focus:outline-none" title="收合/展開列表">
                            <svg id="minimize-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                            <svg id="maximize-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                            </svg>
                        </button>
                    </div>
                    <div id="store-list-content" class="flex-grow overflow-y-auto custom-scrollbar pr-2 transition-all duration-300">
                        <!-- 店家列表將由 JS 動態生成 -->
                    </div>
                </div>

                <!-- MODIFIED: Mobile placement confirmation button position -->
                <button id="complete-placement-btn" class="hidden absolute top-4 left-4 z-20 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors">
                    完成位置設定
                </button>
            </main>
        </div>

        <!-- 新增/編輯店家 Modal (Mobile Popup) -->
        <div id="add-location-modal-mobile" class="hidden fixed inset-0 z-[60] flex items-start justify-center p-4 pt-12 sm:items-center sm:pt-4">
             <!-- Content is the same, just duplicated for simplicity. A framework would reuse the component. -->
             <div class="bg-white shadow-2xl w-full max-w-md rounded-lg flex flex-col" style="max-height: calc(100vh - 5rem);">
                <form id="add-location-form-mobile" class="flex-grow flex flex-col overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                        <h2 id="modal-title-mobile" class="text-xl font-bold text-gray-800">新增地點</h2>
                        <div class="flex items-center space-x-2">
                             <button id="submit-location-btn-mobile" type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center w-28">
                                <span class="submit-text">送出審核</span>
                                <span class="spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                            </button>
                            <button id="close-add-location-modal-mobile" type="button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                        </div>
                    </div>
                    <div class="px-6 pt-2 pb-16 space-y-4 overflow-y-auto custom-scrollbar flex-grow">
                        <!-- Form content will be dynamically cloned from the desktop version -->
                    </div>
                </form>
            </div>
        </div>

        <!-- 篩選 Modal -->
        <div id="filter-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">篩選</h2>
                    <button id="close-filter-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <!-- 分類篩選 -->
                    <div class="mb-4">
                        <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">分類</label>
                        <select id="category-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">所有分類</option>
                        </select>
                    </div>
                    <!-- 關鍵字搜尋 -->
                    <div class="mb-4">
                        <label for="keyword-search" class="block text-sm font-medium text-gray-700 mb-1">關鍵字搜尋</label>
                        <input type="text" id="keyword-search" placeholder="地址、關鍵字" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="p-6 bg-gray-50 border-t rounded-b-lg flex space-x-2">
                    <button id="filter-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        套用篩選
                    </button>
                    <button id="reset-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        重設
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 公司產品 Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 id="product-modal-title" class="text-xl font-bold text-gray-800">黑名原因</h2>
                    <button id="close-product-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div id="product-modal-content" class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar whitespace-pre-wrap"></div>
            </div>
        </div>

        <!-- 管理 Modal -->
        <div id="management-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">我的地點管理</h2>
                    <button id="close-management-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div id="management-list-content" class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <!-- User's stores will be listed here -->
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div id="review-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl flex flex-col" style="height: 90vh;">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">審核地點</h2>
                    <button id="close-review-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                        <button id="pending-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">待審核</button>
                        <button id="approved-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">已審核</button>
                    </nav>
                </div>
                <div class="flex-grow overflow-y-hidden flex">
                    <!-- List Panel -->
                    <div id="review-list-panel" class="w-1/3 border-r overflow-y-auto custom-scrollbar bg-gray-50">
                        <!-- List items will be injected here -->
                    </div>
                    <!-- Detail Panel -->
                    <div id="review-detail-panel" class="w-2/3 p-6 overflow-y-auto custom-scrollbar">
                        <p class="text-gray-500">請從左側列表選擇一個地點以查看詳細資訊。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: In-App Browser Blocker for Facebook -->
        <div id="facebook-blocker-modal" class="fixed inset-0 bg-black/80 z-[200] flex-col items-center justify-center p-8 text-white text-center hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-2xl font-bold mb-4">功能可能受限</h2>
            <p class="text-lg">
                您似乎正在使用 Facebook 內建瀏覽器。
                <br><br>
                為了獲得最佳體驗，建議您點擊畫面右上角的「<span class="font-bold">•••</span>」選單，然後選擇「<span class="font-bold">在瀏覽器中開啟</span>」。
            </p>
        </div>
    </div>

    <script>
        // This function needs to be in the global scope for the Google API to call it.
        function handleCredentialResponse(response) {
            // Decode the JWT to get user profile
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            const profile = JSON.parse(jsonPayload);
            
            const event = new CustomEvent('google-signin-success', { detail: profile });
            window.dispatchEvent(event);
        }
        // Make it globally accessible
        window.handleCredentialResponse = handleCredentialResponse;
    </script>
    
    <script type="module">
        // --- OpenLayers 地圖設定 ---
        
        // MODIFIED: New categories and colors
        const categoryColors = {
            '透天厝': 'rgba(1, 196, 106, 1)',   // Blue
            '公寓大廈': 'rgba(247, 41, 128, 1)',  // Green
            '辦公室': 'rgba(59, 130, 246, 1)',   // Orange
            '飯店': 'rgba(139, 92, 246, 1)',    // Purple
            '其他': 'rgba(107, 114, 128, 1)',   // Gray
        };
        const allCategories = ['透天厝', '公寓大廈', '辦公室', '飯店', '其他'];

        // MODIFIED: SVG Icons for categories with encodeURIComponent and new style
        const mapIcons = {
            '透天厝': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['透天厝']}" stroke="white" stroke-width="1.5"/><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="white"/></svg>`)}`,
            '公寓大廈': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['公寓大廈']}" stroke="white" stroke-width="1.5"/><g transform="scale(0.7) translate(5.5, 3.5)"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" fill="none" stroke-width="1.8" stroke="white"/></g></svg>`)}`,
            '辦公室': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['辦公室']}" stroke="white" stroke-width="1.5"/><g transform="scale(0.7) translate(5.2, 3.5)"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z" fill="white"/></g></svg>`)}`,
            '飯店': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['飯店']}" stroke="white" stroke-width="1.5"/><g transform="scale(0.7) translate(5.2, 3.5)"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2V7c0-2.21-1.79-4-4-4z" fill="white"/></g></svg>`)}`,
            '其他': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['其他']}" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`)}`
        };
        
        const legendIcons = {
            '透天厝': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['透天厝']}" width="28px" height="28px"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`)}`,
            '公寓大廈': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="${categoryColors['公寓大廈']}" width="28px" height="28px"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" /></svg>`)}`,
            '辦公室': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['辦公室']}" width="28px" height="28px"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>`)}`,
            '飯店': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['飯店']}" width="28px" height="28px"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2V7c0-2.21-1.79-4-4-4z"/></svg>`)}`,
            '其他': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['其他']}" width="24px" height="24px"><circle cx="12" cy="12" r="8"/></svg>`)}`
        };
        
        const clusterColorPalette = [
            'rgba(2, 132, 199, 0.8)', 'rgba(217, 70, 239, 0.8)', 'rgba(249, 115, 22, 0.8)',
            'rgba(132, 204, 22, 0.8)', 'rgba(168, 85, 247, 0.8)', 'rgba(239, 68, 68, 0.8)',
        ];

        const styleCache = {};

        const nlscLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}.png',
                attributions: '阿偉 X 國土測繪中心', crossOrigin: 'anonymous'
            })
        });

        const vectorSource = new ol.source.Vector();
        const clusterSource = new ol.source.Cluster({ distance: 50, minDistance: 25, source: vectorSource });

        const lineSource = new ol.source.Vector();
        const lineLayer = new ol.layer.Vector({
            source: lineSource,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(50, 50, 50, 0.7)',
                    width: 1.5,
                    lineDash: [4, 4]
                })
            })
        });
        
        const radiusSource = new ol.source.Vector();
        const radiusLayer = new ol.layer.Vector({
            source: radiusSource,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(59, 130, 246, 0.1)',
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(59, 130, 246, 0.8)',
                    width: 2,
                }),
            }),
        });

        // MODIFIED: Updated address formatting function
        function formatAddress(address) {
            if (!address) return '';
            // Match from the first occurrence of "路", "街", "大道", "巷", "村", or "里"
            const match = address.match(/([^縣市區鄉鎮鎮]+(?:路|街|大道|巷|村|里).*)/);
            return match ? match[1] : address;
        }

        // MODIFIED: clusterStyleFunction to use icons and formatted address
        function clusterStyleFunction(feature) {
            const features = feature.get('features');
            const size = features.length;
            
            if (size > 1) {
                const styleKey = `cluster_${size}`;
                if (!styleCache[styleKey]) {
                    const colorIndex = (size * 5) % clusterColorPalette.length;
                    const clusterColor = clusterColorPalette[colorIndex];
                    styleCache[styleKey] = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 12 + Math.min(size, 20),
                            fill: new ol.style.Fill({ color: clusterColor }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                        }),
                        text: new ol.style.Text({ text: size.toString(), fill: new ol.style.Fill({ color: '#fff' }), font: 'bold 12px sans-serif' }),
                    });
                }
                return styleCache[styleKey];
            } else {
                const originalFeature = features[0];
                const category = originalFeature.get('category') || '其他';
                const singleStyleKey = `single_${category}`;
                
                if (!styleCache[singleStyleKey]) {
                     styleCache[singleStyleKey] = new ol.style.Style({
                        image: new ol.style.Icon({
                            src: mapIcons[category] || mapIcons['其他'], // Use mapIcons here
                            scale: 1, // Adjusted scale for new icons
                            anchor: [0.5, 1], // Anchor at the bottom center
                        })
                    });
                }

                const clonedStyle = styleCache[singleStyleKey].clone();
                const resolution = map.getView().getResolution();

                if (resolution <= 50) {
                    const shortAddress = formatAddress(originalFeature.get('address'));
                    clonedStyle.setText(new ol.style.Text({
                        text: shortAddress, 
                        font: 'bold 13px sans-serif', 
                        fill: new ol.style.Fill({ color: '#333' }),
                        backgroundFill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.85)' }),
                        backgroundStroke: new ol.style.Stroke({ color: categoryColors[category] || categoryColors['其他'], width: 1 }),
                        padding: [5, 7, 5, 7], 
                        offsetY: 8, // Adjust offset for icon
                        overflow: true,
                    }));
                }
                return clonedStyle;
            }
        }

        const clusterLayer = new ol.layer.Vector({ source: clusterSource, style: clusterStyleFunction });

        const map = new ol.Map({
            target: 'map', 
            layers: [nlscLayer, lineLayer, radiusLayer, clusterLayer],
            view: new ol.View({ center: ol.proj.fromLonLat([120.9, 23.9]), zoom: 8 }),
            controls: [
                new ol.control.Zoom(),
                new ol.control.Rotate(),
                new ol.control.Attribution({
                    collapsible: false
                })
            ]
        });

        const popupContainer = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const popupCloser = document.getElementById('popup-closer');

        const infoOverlay = new ol.Overlay({
            element: popupContainer,
            autoPan: { animation: { duration: 250 } },
        });
        map.addOverlay(infoOverlay);

        popupCloser.onclick = function () {
            infoOverlay.setPosition(undefined);
            popupCloser.blur();
            return false;
        };
        
        const userLocationElement = document.getElementById('user-location');
        let userPositionCoords = null;
        const userLocationOverlay = new ol.Overlay({ element: userLocationElement, positioning: 'center-center', stopEvent: false });
        map.addOverlay(userLocationOverlay);

        window.onload = function() {
            const { pinyin } = pinyinPro; 
            let allFeatures = [];
            let rawReports = []; // NEW: Store for individual reports for admin panel
            let fuse = null; 
            let isLoggedIn = false;
            let userProfile = {};
            let isAdmin = false; 
            const isMobile = window.innerWidth < 768;
            
            let initialAddLocationCoords = null;
            let tempMarker = null; // Draggable marker for mobile
            let isDraggingMarker = false;
            
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzw8E-u-fHvl7cpucn2hmOCRzy_UfyWRrqBsadmZcyUolmH9aJFJHIWYpQXX_IyWbs/exec';
            
            const visibilityThreshold = 16.5; 

            // --- Global variable for popup state and votes ---
            let currentFeatureData = null; // Store data of the main feature
            let userVotes = {};
            let currentUserDisplayName = '';
            const VOTES_STORAGE_KEY = 'userBlacklistVotes';
            const SESSION_TOKEN_KEY = 'userSessionToken'; // NEW

            function loadUserVotes() {
                try {
                    const storedVotes = localStorage.getItem(VOTES_STORAGE_KEY);
                    userVotes = storedVotes ? JSON.parse(storedVotes) : {};
                } catch (e) {
                    console.error("Could not load user votes:", e);
                    userVotes = {};
                }
            }

            function saveUserVotes() {
                try {
                    localStorage.setItem(VOTES_STORAGE_KEY, JSON.stringify(userVotes));
                } catch (e) {
                    console.error("Could not save user votes:", e);
                }
            }


            function showNotification(message, type = 'info') {
                const $notification = $('#notification');
                $notification.text(message).removeClass('hidden');
                $notification.removeClass('bg-blue-500 bg-green-500 bg-red-500 bg-yellow-500');
                switch(type) {
                    case 'error': $notification.addClass('bg-red-500'); break;
                    case 'success': $notification.addClass('bg-green-500'); break;
                    case 'warning': $notification.addClass('bg-yellow-500'); break;
                    default: $notification.addClass('bg-blue-500');
                }
                setTimeout(() => $notification.addClass('hidden'), 5000);
            }
            
            async function loadData(city = null) {
                showNotification('正在讀取資料...');
                let url = `${APPS_SCRIPT_URL}?action=getData&t=${new Date().getTime()}`;
                if (city) {
                    url += `&city=${encodeURIComponent(city)}`;
                }
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    
                    const results = await response.json();
                    rawReports = results; // Store raw data for admin panel
                    
                    const groupedData = new Map();
                    results.forEach(data => {
                        const baseAddress = (data['地址'] || '').split(/樓|之|-/)[0].trim();
                        if (baseAddress) {
                            if (!groupedData.has(baseAddress)) {
                                groupedData.set(baseAddress, []);
                            }
                            groupedData.get(baseAddress).push(data);
                        }
                    });

                    vectorSource.clear();
                    allFeatures = [];
                    const pinyinOptions = { pattern: 'pinyin', toneType: 'none', removeNonZh: true };

                    groupedData.forEach((group, baseAddress) => {
                        const firstReport = group[0];
                        const lon = parseFloat(firstReport['經度']);
                        const lat = parseFloat(firstReport['緯度']);

                        if (isNaN(lon) || isNaN(lat)) return;

                        const totalLikes = group.reduce((sum, report) => sum + (parseInt(report.likes, 10) || 0), 0);
                        const totalDislikes = group.reduce((sum, report) => sum + (parseInt(report.dislikes, 10) || 0), 0);

                        const feature = new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
                            name: baseAddress, 
                            category: firstReport['分類'] || '其他', 
                            address: baseAddress,
                            likes: totalLikes,
                            dislikes: totalDislikes,
                            lon: lon, 
                            lat: lat,
                            approved: group.some(r => String(r['審核']).toUpperCase() === 'TRUE'), // If any report is approved, the location is shown
                            reports: group, 
                            address_pinyin: pinyin(baseAddress || '', pinyinOptions),
                        });
                        feature.setId(baseAddress); // Use base address as a unique ID for the location
                        allFeatures.push(feature);
                    });
                    
                    const approvedFeatures = allFeatures.filter(f => f.get('approved'));
                    vectorSource.addFeatures(approvedFeatures);
                    
                    const fuseOptions = {
                        includeScore: true,
                        threshold: 0.1, 
                        minMatchCharLength: 2,
                        ignoreLocation: true,
                        keys: [
                            'values_.address_pinyin',
                            'values_.reports.blacklistReason'
                        ]
                    };
                    fuse = new Fuse(allFeatures, fuseOptions);

                    populateFiltersAndLegend();
                    updateStoreList(); 
                    $('#notification').addClass('hidden');

                } catch (error) {
                    console.error("Load data error:", error);
                    showNotification('無法載入資料！請稍後再試。', 'error');
                }
            }

            // MODIFIED: populateFiltersAndLegend to use icons
            function populateFiltersAndLegend() {
                const $categorySelect = $('#category-select');
                const $addCategorySelect = $('#add-category');
                const $legendContent = $('#legend-content');
                const $storeListFilters = $('#store-list-filters');
                
                $categorySelect.html('<option value="">所有分類</option>');
                $addCategorySelect.html('');
                $legendContent.html('');
                $storeListFilters.html('<button data-category="" class="store-filter-btn active bg-blue-600 text-white px-2 py-0.5 text-xs rounded-full mr-2 flex-shrink-0">全部</button>');
                
                allCategories.forEach(category => {
                     if (legendIcons[category]) { // Use legendIcons here
                        $categorySelect.append(`<option value="${category}">${category}</option>`);
                        $addCategorySelect.append($('<option>', { value: category, text: category }));
                        const iconSrc = legendIcons[category]; // Use legendIcons here
                        $legendContent.append(`<div class="flex items-center"><img src="${iconSrc}" class="h-4 w-4 mr-1.5">${category}</div>`);
                        $storeListFilters.append(`<button data-category="${category}" class="store-filter-btn text-nowrap bg-white text-black px-2 py-0.5 text-xs rounded-full mr-2 flex-shrink-0 border" style="border-color: ${categoryColors[category]};">${category}</button>`);
                     }
                });
            }
            
            function applyFilters() {
                const category = $('#category-select').val();
                const keyword = $('#keyword-search').val();
                
                let results = allFeatures;

                if (keyword && fuse) {
                    const pinyinKeyword = pinyin(keyword, { pattern: 'pinyin', toneType: 'none', removeNonZh: true });
                    const fuseResult = fuse.search(pinyinKeyword);
                    results = fuseResult.map(result => result.item);
                }

                const finalFeatures = results.filter(feature => {
                    if (!feature.get('approved')) return false;
                    if (category && feature.get('category') !== category) return false;
                    return true;
                });
                
                vectorSource.clear();
                vectorSource.addFeatures(finalFeatures);
                updateStoreList(); 
                $('#filter-modal').addClass('hidden');
            }
            
            $('#open-filter-modal').on('click', () => $('#filter-modal').removeClass('hidden'));
            $('#close-filter-modal, #filter-btn').on('click', () => $('#filter-modal').addClass('hidden'));
            $('#filter-btn').on('click', applyFilters);
            $('#reset-btn').on('click', () => {
                $('#category-select, #keyword-search').val('');
                const approvedFeatures = allFeatures.filter(f => f.get('approved'));
                vectorSource.clear();
                vectorSource.addFeatures(approvedFeatures);
                updateStoreList(); 
            });
            $('#close-product-modal').on('click', () => $('#product-modal').addClass('hidden'));

            $('#center-on-me-btn').on('click', () => {
                if (userPositionCoords) map.getView().animate({ center: userPositionCoords, zoom: 16, duration: 800 });
                else showNotification('無法定位您的位置。', 'warning');
            });
            $(document).on('click', '#show-more-product', function() {
                $('#product-modal-title').text('黑名原因');
                // Use decodeURIComponent to handle special characters correctly
                $('#product-modal-content').text(decodeURIComponent($(this).data('fulltext')));
                $('#product-modal').removeClass('hidden');
            });
            
            // --- NEW/MODIFIED Add Location Logic ---
            
            function drawRadiusCircle(centerCoords) {
                radiusSource.clear();
                const view = map.getView();
                const projection = view.getProjection();
                const resolution = view.getResolution();
                // *** 可修改數字：這裡設定了初始定位時顯示的圓圈半徑（單位：公尺） ***
                const radius = 5000; 
                
                const circle = new ol.geom.Circle(centerCoords, radius / ol.proj.getPointResolution(projection, resolution, centerCoords));
                const circleFeature = new ol.Feature(circle);
                radiusSource.addFeature(circleFeature);
            }

            function handlePointerMove(e) {
                if (isDraggingMarker) {
                    const newCoord = map.getEventCoordinate(e);
                    const initialLonLat = ol.proj.toLonLat(initialAddLocationCoords);
                    const newLonLat = ol.proj.toLonLat(newCoord);
                    
                    // *** 可修改數字：這裡設定了用戶可以拖動標記的最大距離（單位：公尺） ***
                    const maxDistance = 5000;

                    if (ol.sphere.getDistance(initialLonLat, newLonLat) <= maxDistance) {
                        tempMarker.setPosition(newCoord);
                    } else {
                        // Snap to edge if dragged too far
                        const angle = Math.atan2(newCoord[1] - initialAddLocationCoords[1], newCoord[0] - initialAddLocationCoords[0]);
                        const resolution = map.getView().getResolution();
                        const radiusInMapUnits = maxDistance / ol.proj.getPointResolution(map.getView().getProjection(), resolution, initialAddLocationCoords);
                        const edgeX = initialAddLocationCoords[0] + radiusInMapUnits * Math.cos(angle);
                        const edgeY = initialAddLocationCoords[1] + radiusInMapUnits * Math.sin(angle);
                        tempMarker.setPosition([edgeX, edgeY]);
                    }
                }
            }

            function handlePointerUp() {
                if (isDraggingMarker) {
                    map.getInteractions().forEach(i => { if(i instanceof ol.interaction.DragPan) i.setActive(true); });
                    document.removeEventListener('pointermove', handlePointerMove);
                    document.removeEventListener('pointerup', handlePointerUp);
                    isDraggingMarker = false;
                }
            }
            
            function enterMobilePlacementMode(coordinate) {
                initialAddLocationCoords = coordinate;
                if(tempMarker) map.removeOverlay(tempMarker);

                const markerEl = document.createElement('div');
                markerEl.className = 'new-location-marker';
                
                tempMarker = new ol.Overlay({
                    element: markerEl, position: coordinate, positioning: 'bottom-center', stopEvent: false,
                });
                map.addOverlay(tempMarker);
                drawRadiusCircle(coordinate);
                $('#complete-placement-btn').removeClass('hidden');

                markerEl.addEventListener('pointerdown', (e) => {
                    isDraggingMarker = true;
                    map.getInteractions().forEach(i => { if(i instanceof ol.interaction.DragPan) i.setActive(false); });
                    document.addEventListener('pointermove', handlePointerMove);
                    document.addEventListener('pointerup', handlePointerUp);
                    e.stopPropagation();
                });
                
                map.getView().animate({ center: coordinate, zoom: 18, duration: 500 });
            }

            function enterDesktopAddMode(coordinate) {
                initialAddLocationCoords = coordinate;
                $('#app-container').addClass('desktop-add-mode');
                $('#desktop-center-marker').removeClass('hidden');
                
                setTimeout(() => {
                    map.updateSize();
                    drawRadiusCircle(coordinate);
                    map.getView().animate({ center: coordinate, zoom: 17, duration: 500 }, () => {
                        const centerCoords = map.getView().getCenter();
                        const centerLonLat = ol.proj.toLonLat(centerCoords);
                        reverseGeocode(centerLonLat[0], centerLonLat[1]);
                    });
                }, 350);

                map.on('moveend', handleDesktopMapMove);
            }
            
            function handleDesktopMapMove() {
                if ($('#app-container').hasClass('desktop-add-mode')) {
                    const centerCoords = map.getView().getCenter();
                    const centerLonLat = ol.proj.toLonLat(centerCoords);
                    reverseGeocode(centerLonLat[0], centerLonLat[1]);
                }
            }
            
            function exitAddMode() {
                radiusSource.clear();
                initialAddLocationCoords = null;
                
                if (isMobile) {
                    if(tempMarker) map.removeOverlay(tempMarker);
                    tempMarker = null;
                    $('#complete-placement-btn').addClass('hidden');
                    $('#add-location-modal-mobile').addClass('hidden');
                } else {
                    $('#app-container').removeClass('desktop-add-mode');
                    $('#desktop-center-marker').addClass('hidden');
                    map.un('moveend', handleDesktopMapMove);
                    setTimeout(() => map.updateSize(), 350);
                }
            }

            $('#add-location-btn').on('click', function() {
                if (!isLoggedIn) {
                    showNotification('請先登入才能新增店家！', 'warning');
                    return;
                }
                showNotification('正在取得您的目前位置...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => { // Success
                        const coords = [position.coords.longitude, position.coords.latitude];
                        const mapCoords = ol.proj.fromLonLat(coords);
                        
                        if (isMobile) {
                            enterMobilePlacementMode(mapCoords);
                        } else {
                            enterDesktopAddMode(mapCoords);
                        }
                    },
                    (error) => { // Error
                        showNotification('無法取得您的位置，請手動輸入地址。', 'warning');
                        if (isMobile) {
                            showNotification('在行動裝置上需要定位權限才能新增店家。', 'error');
                        } else {
                            enterDesktopAddMode(map.getView().getCenter());
                        }
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            });
            
            $('#complete-placement-btn').on('click', function() {
                const finalCoords = tempMarker.getPosition();
                const finalLonLat = ol.proj.toLonLat(finalCoords);
                
                const formContent = $('#add-location-form > .px-6').clone(true, true);
                $('#add-location-form-mobile > .px-6').replaceWith(formContent);

                $('#add-location-form-mobile')[0].reset();
                reverseGeocode(finalLonLat[0], finalLonLat[1], $('#add-location-form-mobile'));
                
                $('#add-location-modal-mobile').removeClass('hidden');
                $('#complete-placement-btn').addClass('hidden');
            });

            $('#close-add-location-modal, #close-add-location-modal-mobile').on('click', exitAddMode);

            // --- REFACTORED: Popup Logic ---

            function extractAddressNumbers(address) {
                if (!address) return [Infinity];
                address = address.replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0) - 65248))
                                 .replace(/地下/g, 'B')
                                 .replace(/之/g, '.');
                const numbers = address.match(/B?\d+(\.\d+)?/g);
                if (!numbers) return [Infinity];
                return numbers.map(n => n.startsWith('B') ? -parseFloat(n.substring(1)) : parseFloat(n));
            }

            function compareAddresses(a, b) {
                const numsA = extractAddressNumbers(a);
                const numsB = extractAddressNumbers(b);
                const minLength = Math.min(numsA.length, numsB.length);
                for (let i = 0; i < minLength; i++) {
                    if (numsA[i] !== numsB[i]) return numsA[i] - numsB[i];
                }
                return numsA.length - numsB.length;
            }

            function renderConsolidatedPopup(featureData, reports) {
                const shortAddress = formatAddress(reports[0]['地址']);
                let reportsHtml = reports.map(report => {
                    const reportDate = report.timestamp || report.Timestamp;
                    const dateString = reportDate ? new Date(reportDate).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }) : '日期不明';
                    return `
                        <div class="border-t pt-2 mt-2">
                            <p class="text-xs text-gray-500">${report.submitterName || '匿名'} &bull; ${dateString}</p>
                            <p class="font-semibold">${report['黑名類別']}</p>
                            <p class="whitespace-pre-wrap">${report['黑名原因'] || ''}</p>
                        </div>
                    `;
                }).join('');

                popupContent.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800">${shortAddress}</h3>
                    ${renderVoteSection(featureData)}
                    <div class="text-sm mt-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">
                        ${reportsHtml}
                    </div>
                `;
            }

            function renderUnitListPopup(featureData, reportsByFullAddress) {
                const shortAddress = formatAddress(featureData.address);
                const sortedAddresses = Array.from(reportsByFullAddress.keys()).sort(compareAddresses);

                let listHtml = sortedAddresses.map(fullAddr => {
                    const addrMatch = fullAddr.match(/(\d.*)/);
                    const displayAddr = addrMatch ? addrMatch[1].trim() : fullAddr;
                    return `
                        <li class="border-t py-2 px-1 cursor-pointer hover:bg-gray-100 rounded unit-item" data-address="${encodeURIComponent(fullAddr)}">
                            <p class="font-semibold truncate" title="${fullAddr}">${displayAddr}</p>
                        </li>
                    `;
                }).join('');

                popupContent.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800">${shortAddress}</h3>
                    ${renderVoteSection(featureData)}
                    <p class="text-sm text-gray-600 my-2 border-t pt-2">此地點有多筆回報，請選擇查看：</p>
                    <ul class="text-sm max-h-40 overflow-y-auto custom-scrollbar pr-2">${listHtml}</ul>
                `;
            }

            function renderVoteSection(featureData) {
                const likes = featureData.likes || 0;
                const dislikes = featureData.dislikes || 0;
                const score = likes - dislikes;
                let scoreColor = 'text-gray-600';
                if (score > 0) scoreColor = 'text-green-600';
                if (score < 0) scoreColor = 'text-red-600';

                const locationId = featureData.address;
                const userVote = userVotes[locationId];
                const likeClass = userVote === 'like' ? 'voted-like' : '';
                const dislikeClass = userVote === 'dislike' ? 'voted-dislike' : '';

                return `
                    <div class="flex items-center justify-between text-sm mt-2">
                        <span>總評分 (<span class="score-display ${scoreColor} font-bold">${score}</span>)</span>
                        <div class="flex items-center space-x-2">
                            <button class="vote-btn p-1 rounded-full hover:bg-gray-200 ${likeClass}" data-location-id="${locationId}" data-vote-type="like">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333V17a1 1 0 001 1h6.364a1 1 0 00.949-.684l2.121-6.364A1 1 0 0015.364 9H12V4a1 1 0 00-1-1h-1a1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.4 10.333zM6 8h2.545M5 10.5a1.5 1.5 0 01-1.5-1.5V6a1.5 1.5 0 013 0v3a1.5 1.5 0 01-1.5 1.5z"/></svg>
                            </button>
                             <span class="likes-count text-sm text-gray-600">${likes}</span>
                            <button class="vote-btn p-1 rounded-full hover:bg-gray-200 ${dislikeClass}" data-location-id="${locationId}" data-vote-type="dislike">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667V3a1 1 0 00-1-1h-6.364a1 1 0 00-.949.684L3.565 9H6v7a1 1 0 001 1h1a1 1 0 001-1v-.667a4 4 0 01.8-2.4l1.6-4.8zM14 12h-2.545M15 9.5a1.5 1.5 0 011.5 1.5v3a1.5 1.5 0 01-3 0v-3a1.5 1.5 0 011.5-1.5z"/></svg>
                            </button>
                             <span class="dislikes-count text-sm text-gray-600">${dislikes}</span>
                        </div>
                    </div>
                `;
            }

            $('#popup').on('click', function(e) {
                const $target = $(e.target);
                
                const $unitItem = $target.closest('.unit-item');
                if ($unitItem.length) {
                    const fullAddress = decodeURIComponent($unitItem.data('address'));
                    const reportsForUnit = currentFeatureData.reports.filter(r => r['地址'] === fullAddress);
                    renderConsolidatedPopup(currentFeatureData, reportsForUnit);
                    return;
                }

                const $clusterItem = $target.closest('.cluster-item');
                if ($clusterItem.length) {
                    const address = decodeURIComponent($clusterItem.data('address'));
                    const targetFeature = allFeatures.find(f => f.getId() === address);
                    if (targetFeature) {
                        const data = targetFeature.getProperties();
                        currentFeatureData = data;
                        
                        const reportsByFullAddress = new Map();
                        data.reports.forEach(report => {
                            const fullAddr = report['地址'];
                            if (!reportsByFullAddress.has(fullAddr)) {
                                reportsByFullAddress.set(fullAddr, []);
                            }
                            reportsByFullAddress.get(fullAddr).push(report);
                        });

                        if (reportsByFullAddress.size > 1) {
                            renderUnitListPopup(data, reportsByFullAddress);
                        } else {
                            renderConsolidatedPopup(data, data.reports);
                        }
                    }
                    return;
                }

                const $voteBtn = $target.closest('.vote-btn');
                if ($voteBtn.length) {
                    if (!isLoggedIn) {
                        showNotification('請先登入才能評分！', 'warning');
                        return;
                    }
                    
                    const locationId = $voteBtn.data('location-id');
                    const voteType = $voteBtn.data('vote-type');
                    const previousVote = userVotes[locationId];

                    let likeChange = 0;
                    let dislikeChange = 0;

                    if (previousVote === voteType) { 
                        userVotes[locationId] = null;
                        voteType === 'like' ? likeChange = -1 : dislikeChange = -1;
                    } else if (previousVote) { 
                        userVotes[locationId] = voteType;
                        if (voteType === 'like') {
                            likeChange = 1;
                            dislikeChange = -1;
                        } else {
                            likeChange = -1;
                            dislikeChange = 1;
                        }
                    } else { 
                        userVotes[locationId] = voteType;
                        voteType === 'like' ? likeChange = 1 : dislikeChange = 1;
                    }
                    
                    saveUserVotes();
                    
                    const $popup = $voteBtn.closest('.ol-popup');
                    const currentLikes = parseInt($popup.find('.likes-count').text());
                    const currentDislikes = parseInt($popup.find('.dislikes-count').text());
                    const newLikes = currentLikes + likeChange;
                    const newDislikes = currentDislikes + dislikeChange;
                    
                    $popup.find('.likes-count').text(newLikes);
                    $popup.find('.dislikes-count').text(newDislikes);
                    $popup.find('.score-display').text(newLikes - newDislikes);
                    
                    $popup.find('.vote-btn').removeClass('voted-like voted-dislike');
                    if(userVotes[locationId] === 'like') $popup.find('.vote-btn[data-vote-type="like"]').addClass('voted-like');
                    if(userVotes[locationId] === 'dislike') $popup.find('.vote-btn[data-vote-type="dislike"]').addClass('voted-dislike');

                    if(likeChange !== 0) sendVote(locationId, 'like', likeChange);
                    if(dislikeChange !== 0) sendVote(locationId, 'dislike', dislikeChange);
                }
            });

            function sendVote(locationId, voteType, change) {
                const feature = allFeatures.find(f => f.getId() === locationId);
                if (!feature) return;

                feature.get('reports').forEach(report => {
                    const payload = {
                        action: 'vote',
                        rowIndex: report.rowIndex,
                        voteType: voteType,
                        change: change
                    };
                    fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .catch(error => console.error('Vote submission failed:', error));
                });
            }

            map.on('singleclick', function (evt) {
                if ($('#app-container').hasClass('desktop-add-mode')) return;
                
                const feature = map.forEachFeatureAtPixel(evt.pixel, f => f);
                infoOverlay.setPosition(undefined);
                if (feature) {
                    const featuresInCluster = feature.get('features');
                    if (featuresInCluster.length > 1) { 
                        const currentZoom = map.getView().getZoom();
                        const maxZoomForFit = 17;

                        if (currentZoom > maxZoomForFit) {
                            const coordinates = evt.coordinate;
                            const reportsByAddress = new Map();
                            featuresInCluster.forEach(feat => {
                                const featureData = feat.getProperties();
                                const baseAddress = featureData.address;
                                if (!reportsByAddress.has(baseAddress)) {
                                    reportsByAddress.set(baseAddress, []);
                                }
                                reportsByAddress.get(baseAddress).push(...featureData.reports);
                            });

                            let listHtml = '';
                            reportsByAddress.forEach((reports, address) => {
                                listHtml += `
                                    <li class="border-t py-2 px-1 cursor-pointer hover:bg-gray-100 rounded cluster-item" data-address="${encodeURIComponent(address)}">
                                        <p class="font-semibold truncate" title="${address}">${formatAddress(address)} (${reports.length})</p>
                                    </li>
                                `;
                            });
                            
                            popupContent.innerHTML = `
                                <h3 class="text-lg font-bold text-gray-800">附近有多個地點</h3>
                                <p class="text-sm text-gray-600 my-2">請選擇要查看的地點：</p>
                                <ul class="text-sm max-h-48 overflow-y-auto custom-scrollbar pr-2">${listHtml}</ul>
                            `;
                            infoOverlay.setPosition(coordinates);
                        } else {
                            const extent = ol.extent.createEmpty();
                            featuresInCluster.forEach(f => ol.extent.extend(extent, f.getGeometry().getExtent()));
                            map.getView().fit(extent, { duration: 500, padding: [80, 80, 80, 80] });
                        }
                    } else { 
                        const originalFeature = featuresInCluster[0];
                        const coordinates = originalFeature.getGeometry().getCoordinates();
                        currentFeatureData = originalFeature.getProperties();
                        
                        const reportsByFullAddress = new Map();
                        currentFeatureData.reports.forEach(report => {
                            const fullAddr = report['地址'];
                            if (!reportsByFullAddress.has(fullAddr)) {
                                reportsByFullAddress.set(fullAddr, []);
                            }
                            reportsByFullAddress.get(fullAddr).push(report);
                        });
                        
                        map.getView().animate({ center: coordinates, zoom: 18, duration: 800 });

                        if (reportsByFullAddress.size > 1) {
                            renderUnitListPopup(currentFeatureData, reportsByFullAddress);
                        } else {
                            renderConsolidatedPopup(currentFeatureData, currentFeatureData.reports);
                        }
                        infoOverlay.setPosition(coordinates);
                    }
                }
            });
            
            async function reverseGeocode(lon, lat, $form = $('#add-location-form')) {
                const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                const $addressInput = $form.find('#add-address');
                try {
                    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}&language=zh-TW`);
                    if (!response.ok) throw new Error('Geocoding API response not OK');
                    const data = await response.json();
                    $addressInput.val(data.results && data.results.length > 0 ? data.results[0].formatted_address : '無法自動定位地址');
                } catch (error) {
                    $addressInput.val('無法自動定位地址');
                    showNotification('無法解析地址，請手動輸入。', 'warning');
                }
            }
            
            $(document).on('change', '#add-address', function() {
                const $form = $(this).closest('form');
                if ($(this).val()) {
                    const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                    fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent($(this).val())}&key=${apiKey}&region=TW`)
                    .then(res => res.json()).then(data => {
                        if (data.results && data.results.length > 0) {
                            const location = data.results[0].geometry.location;
                            const coords = ol.proj.fromLonLat([location.lng, location.lat]);
                            
                            if (isMobile) {
                                if (tempMarker) tempMarker.setPosition(coords);
                            } else {
                                map.getView().setCenter(coords);
                            }
                            map.getView().setZoom(17);

                        } else showNotification('找不到輸入的地址', 'error');
                    }).catch(err => showNotification('地址解析失敗', 'error'));
                }
            });

            function handleFormSubmit(e) {
                e.preventDefault(); 
                const $form = $(e.target);
                const $submitBtn = $form.find('.submit-text').parent();
                
                const formData = new FormData($form[0]);
                const reasonText = formData.get('blacklistReason').trim();
                const chineseCharMatch = reasonText.match(/[\u4e00-\u9fa5]/g);

                if (!chineseCharMatch || chineseCharMatch.length < 3) {
                    showNotification('黑名原因請至少輸入3個中文字。', 'error');
                    return;
                }
                
                let finalCoords;
                if (isMobile) {
                    if (!tempMarker) {
                        showNotification('請在地圖上設定一個位置。', 'error');
                        return;
                    }
                    finalCoords = tempMarker.getPosition();
                } else {
                    finalCoords = map.getView().getCenter();
                }

                if (initialAddLocationCoords) {
                    const initialLonLat = ol.proj.toLonLat(initialAddLocationCoords);
                    const finalLonLat = ol.proj.toLonLat(finalCoords);
                    const distance = ol.sphere.getDistance(initialLonLat, finalLonLat);
                    
                    // *** 可修改數字：這裡設定了用戶可以拖動標記的最大距離（單位：公尺） ***
                    const maxDistance = 5000;

                    if (distance > maxDistance) {
                        showNotification(`修改後の位置(${Math.round(distance)}公尺)不能超過初始定位點${maxDistance}公尺。`, 'error');
                        return;
                    }
                }
                
                $submitBtn.prop('disabled', true).find('.submit-text').addClass('hidden');
                $submitBtn.find('.spinner').removeClass('hidden');
                
                const lonLat = ol.proj.toLonLat(finalCoords);
                const rowIndex = $form.find('#edit-row-index').val();
                const originalName = $form.find('#edit-original-name').val();
                
                let action = 'create';
                if (rowIndex) action = 'admin_modify';
                else if (originalName) action = 'update';

                const newData = {
                    action: action, rowIndex: rowIndex, originalName: originalName, 
                    submitterName: currentUserDisplayName || 'N/A',
                    submitterEmail: userProfile.email || null, // Can be null for LINE users
                    submitterLineId: userProfile.lineUserId || null, // Add new field for LINE users
                    adminEmail: userProfile.email, 
                    name: formData.get('address'), 
                    category: formData.get('category'), 
                    address: formData.get('address'), 
                    blacklistCategory: formData.get('blacklistCategory'),
                    blacklistReason: reasonText,
                    lon: lonLat[0], 
                    lat: lonLat[1],
                    timestamp: new Date().toISOString(),
                };
                
                fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(newData) })
                .then(() => {
                    showNotification("資料已成功送出！感謝您的貢獻。", 'success');
                    exitAddMode();
                    setTimeout(loadData, 2000);
                }).catch(error => {
                    showNotification('送出失敗，請稍後再試。', 'error');
                }).finally(() => {
                    $submitBtn.prop('disabled', false).find('.submit-text').removeClass('hidden').end().find('.spinner').addClass('hidden');
                });
            }

            $('#add-location-form').on('submit', handleFormSubmit);
            $('#add-location-form-mobile').on('submit', handleFormSubmit);

            async function reverseGeocodeForCity(lon, lat) {
                const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                try {
                    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}&language=zh-TW&result_type=administrative_area_level_1`);
                    if (!response.ok) throw new Error('Geocoding API response not OK');
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const cityComponent = data.results[0].address_components.find(c => c.types.includes('administrative_area_level_1'));
                        if (cityComponent) {
                            return cityComponent.long_name;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error("Reverse geocoding for city failed:", error);
                    return null;
                }
            }

            async function initializeUserLocation() {
                if (!navigator.geolocation) {
                    showNotification('您的瀏覽器不支援地理定位', 'warning');
                    loadData(); 
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        userPositionCoords = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                        map.getView().animate({ center: userPositionCoords, zoom: 16, duration: 1500 });
                        userLocationOverlay.setPosition(userPositionCoords);
                        $('#user-location').removeClass('hidden');

                        const city = await reverseGeocodeForCity(pos.coords.longitude, pos.coords.latitude);
                        loadData(city);
                    },
                    (err) => {
                        showNotification('無法取得您的位置，將顯示全台地圖。', 'warning');
                        loadData(); // Load all data on error
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            }
            
            async function checkIfAdmin(email) {
                if (!email) return; // Don't check for admin if email is not available (LINE users)
                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=checkAdmin&email=${encodeURIComponent(email)}`);
                    if (!response.ok) throw new Error('Admin check failed');
                    const result = await response.json();
                    
                    if (result.isAdmin) {
                        isAdmin = true;
                        $('#review-btn').removeClass('hidden');
                    } else {
                        isAdmin = false;
                        $('#review-btn').addClass('hidden');
                    }
                } catch (error) {
                    showNotification('無法驗證管理員身份', 'error');
                }
            }
            
            // --- NEW/MODIFIED Login Logic ---

            function setLoginState(profile) {
                isLoggedIn = true;
                userProfile = profile; // This now contains { name, email?, lineUserId? }
                
                const storageKey = userProfile.email ? `nickname_${userProfile.email}` : `nickname_${userProfile.lineUserId}`;
                const storedNickname = localStorage.getItem(storageKey);
                currentUserDisplayName = storedNickname || profile.name;

                $('#google-signin-container').hide();
                $('#line-login-container').hide();
                $('#add-info').removeClass('hidden').addClass('flex');
                $('#user-name').text(currentUserDisplayName);
                checkIfAdmin(userProfile.email); // Admin check still relies on email
            }

            function initializeGoogleButton(isLineEnvironment = false) {
                const $container = $('#google-signin-container');
                const googleLoginLiffUrl = 'https://liff.line.me/2008020548-lVYKgg0B';

                if (isLineEnvironment) {
                    // 在 LINE 環境中，渲染一個自訂按鈕，點擊後打開 LIFF 視窗
                    const googleButtonHtml = `
                        <button id="liff-google-login-btn" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg shadow-md flex items-center justify-center w-full hover:bg-gray-50 transition-colors">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" class="w-5 h-5 mr-3" alt="Google Logo">
                            <span class="font-medium">透過 Google 登入</span>
                        </button>
                    `;
                    $container.html(googleButtonHtml).show();
                    $('#liff-google-login-btn').on('click', function() {
                        if (liff && liff.openWindow) {
                            liff.openWindow({ url: googleLoginLiffUrl });
                        } else {
                            showNotification('無法開啟登入視窗，請確認 LIFF 初始化成功。', 'error');
                        }
                    });
                } else {
                    // 在 LINE 之外的環境，渲染真正的 Google 登入按鈕
                    if (window.google && window.google.accounts && window.google.accounts.id) {
                        google.accounts.id.initialize({
                            client_id: '35839698842-b73h9naufqdm7d0j378882k1e6aq6064.apps.googleusercontent.com',
                            callback: handleCredentialResponse
                        });
                        google.accounts.id.renderButton(
                            $container[0],
                            { type: 'standard', size: 'large', theme: 'outline', text: 'sign_in_with', shape: 'rectangular', logo_alignment: 'left' } 
                        );
                        $container.show();
                    } else {
                        setTimeout(() => initializeGoogleButton(false), 200);
                    }
                }
            }
            
            async function handleLineLogin(lineProfile) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'line_login', profile: lineProfile })
                    });
                    const result = await response.json();
                    if (result.status === 'success' && result.user) {
                        localStorage.setItem(SESSION_TOKEN_KEY, result.token);
                        setLoginState({
                            name: result.user.name,
                            lineUserId: result.user.lineUserId,
                            email: null
                        });
                    } else {
                        showNotification('LINE 登入失敗，請稍後再試。', 'error');
                    }
                } catch (error) {
                    console.error('LINE Login process failed:', error);
                    showNotification('LINE 登入時發生錯誤。', 'error');
                }
            }

            async function verifyToken() {
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                if (!token) {
                    // 如果沒有 token，且不在 LINE 環境中，才顯示 Google 登入
                    if (!liff.isInClient()) {
                         initializeGoogleButton(false);
                    }
                    return;
                }

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'verify_token', token: token })
                    });
                    const result = await response.json();
                    if (result.status === 'success' && result.user) {
                        setLoginState(result.user);
                    } else {
                        localStorage.removeItem(SESSION_TOKEN_KEY);
                        if (!liff.isInClient()) {
                            initializeGoogleButton(false);
                        }
                    }
                } catch(error) {
                    console.error('Token verification failed:', error);
                    localStorage.removeItem(SESSION_TOKEN_KEY);
                     if (!liff.isInClient()) {
                        initializeGoogleButton(false);
                    }
                }
            }

            window.addEventListener('google-signin-success', async (e) => {
                const googleProfile = e.detail;
                 try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'google_login', profile: googleProfile })
                    });
                    const result = await response.json();

                    if (result.status === 'success' && result.token) {
                        localStorage.setItem(SESSION_TOKEN_KEY, result.token);
                        setLoginState({
                            email: googleProfile.email,
                            name: googleProfile.given_name || googleProfile.name,
                            lineUserId: null
                        });
                    } else {
                        showNotification('登入失敗，請稍後再試。', 'error');
                    }
                } catch(error) {
                    console.error('Google login process failed:', error);
                    showNotification('登入時發生錯誤。', 'error');
                }
            });

            $(document).on('click', '#edit-nickname-btn', function() {
                const currentName = $('#user-name').text();
                const newName = prompt("請輸入您的新暱稱：", currentName);

                if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                    currentUserDisplayName = newName.trim();
                    const storageKey = userProfile.email ? `nickname_${userProfile.email}` : `nickname_${userProfile.lineUserId}`;
                    localStorage.setItem(storageKey, currentUserDisplayName);
                    $('#user-name').text(currentUserDisplayName);
                    
                    const payload = {
                        action: 'update_nickname',
                        userEmail: userProfile.email,
                        lineUserId: userProfile.lineUserId,
                        newName: currentUserDisplayName
                    };

                    fetch(APPS_SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors',
                        body: JSON.stringify(payload) 
                    })
                    .then(() => {
                        showNotification('暱稱已同步更新！', 'success');
                    })
                    .catch(error => {
                        console.error('Nickname sync failed:', error);
                        showNotification('暱稱同步失敗，請稍後再試。', 'error');
                    });

                } else if (newName === '') {
                    showNotification('暱稱不能為空。', 'error');
                }
            });

            $('#sign-out-btn').on('click', (e) => {
                e.preventDefault();
                
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'logout', token: token })
                });

                localStorage.removeItem(SESSION_TOKEN_KEY);
                const storageKey = userProfile.email ? `nickname_${userProfile.email}` : `nickname_${userProfile.lineUserId}`;
                localStorage.removeItem(storageKey);

                if (liff.isLoggedIn()) {
                    liff.logout();
                }
                if (window.google && google.accounts && google.accounts.id) {
                    google.accounts.id.disableAutoSelect();
                }
                
                isLoggedIn = false; 
                userProfile = {};
                isAdmin = false;
                currentUserDisplayName = '';

                $('#add-info').removeClass('flex').addClass('hidden');
                $('#review-btn').addClass('hidden');
                
                if (liff.isInClient()) {
                    $('#line-login-container').show();
                    $('#google-signin-container').empty().show();
                    initializeGoogleButton(true);
                } else {
                    $('#line-login-container').hide();
                    $('#google-signin-container').empty().show();
                    initializeGoogleButton(false);
                }

                showNotification('您已成功登出。');
            });
            
            function updateStoreList() {
                const extent = map.getView().calculateExtent(map.getSize());
                const $listContent = $('#store-list-content');
                const activeCategory = $('#store-list-filters .active').data('category');
                $listContent.html('');
                
                let count = 0;
                const featuresInView = vectorSource.getFeaturesInExtent(extent);
                
                const uniqueFeatures = [];
                const featureKeys = new Set();

                clusterSource.forEachFeatureInExtent(extent, function(cluster) {
                    const features = cluster.get('features');
                    features.forEach(function(feature) {
                        if (!featureKeys.has(feature.getId())) {
                            uniqueFeatures.push(feature);
                            featureKeys.add(feature.getId());
                        }
                    });
                });

                uniqueFeatures.forEach(function(feature) {
                    if (count >= 200) return;

                    const category = feature.get('category');
                    if (!activeCategory || category === activeCategory) {
                         const address = feature.get('address');
                         const shortAddress = formatAddress(address);
                         const color = categoryColors[category] || categoryColors['其他'];
                         const listItem = $(`
                            <div class="flex items-center text-sm py-1.5 px-2 cursor-pointer hover:bg-gray-200 rounded-md">
                                <span class="h-2.5 w-2.5 rounded-full mr-2 flex-shrink-0" style="background-color: ${color}"></span>
                                <span class="truncate">${shortAddress}</span>
                            </div>
                         `);
                         listItem.on('click', () => {
                             const coordinates = feature.getGeometry().getCoordinates();
                             map.getView().animate({ center: coordinates, zoom: 18, duration: 800 });
                             setTimeout(() => {
                                 const data = feature.getProperties();
                                 currentFeatureData = data;
                                 
                                 const reportsByFullAddress = new Map();
                                 data.reports.forEach(report => {
                                     const fullAddr = report['地址'];
                                     if (!reportsByFullAddress.has(fullAddr)) {
                                         reportsByFullAddress.set(fullAddr, []);
                                     }
                                     reportsByFullAddress.get(fullAddr).push(report);
                                 });

                                 if (reportsByFullAddress.size > 1) {
                                     renderUnitListPopup(data, reportsByFullAddress);
                                 } else {
                                     renderConsolidatedPopup(data, data.reports);
                                 }
                                 infoOverlay.setPosition(coordinates);
                             }, 200);
                         });
                         $listContent.append(listItem);
                         count++;
                    }
                });
            }

            map.on('moveend', updateStoreList);

            $('#store-list-filters').on('click', '.store-filter-btn', function() {
                const $clickedBtn = $(this);
                const clickedCategory = $clickedBtn.data('category');
                
                $('.store-filter-btn').removeClass('active text-white text-red-600 bg-blue-600').addClass('text-black bg-white');

                $clickedBtn.addClass('active');
                if (clickedCategory === '') {
                    $clickedBtn.removeClass('bg-white text-black').addClass('bg-blue-600 text-white');
                } else {
                    $clickedBtn.removeClass('text-black').addClass('text-red-600');
                }
                
                updateStoreList();
            });
            
            $('#toggle-store-list-btn').on('click', function() {
                const $panel = $('#store-list-panel');
                const $content = $('#store-list-content');
                
                $content.toggleClass('hidden');
                $('#minimize-icon').toggleClass('hidden');
                $('#maximize-icon').toggleClass('hidden');
                
                if ($content.hasClass('hidden')) {
                    $panel.css('max-height', '55px'); 
                } else {
                    $panel.css('max-height', '14rem'); 
                }
            });

            map.getView().on('change:resolution', () => {
                const zoom = map.getView().getZoom();
                if (zoom <= visibilityThreshold) {
                    lineSource.clear();
                }
            });
            
            // --- REFACTORED: Management Modal Logic ---
            $('#manage-btn').on('click', function() {
                const userReports = rawReports.filter(r => 
                    (userProfile.email && r.submitterEmail === userProfile.email) ||
                    (userProfile.lineUserId && r.submitterLineId === userProfile.lineUserId)
                );
                const $content = $('#management-list-content');
                $content.html('');

                if (userReports.length === 0) {
                    $content.html('<p class="text-gray-500">您尚未提交任何地點。</p>');
                } else {
                    userReports.forEach(report => {
                        const isApproved = String(report['審核']).toUpperCase() === 'TRUE';
                        const status = isApproved ? '<span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">已審核</span>' : '<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">審核中</span>';
                        
                        const itemHtml = `
                            <div class="flex justify-between items-center py-2 border-b">
                                <div>
                                    <p class="font-bold">${report['地址']}</p>
                                    <p class="text-sm text-gray-500 truncate">${report['黑名類別']}: ${report['黑名原因']}</p>
                                </div>
                                <div class="flex items-center space-x-2 flex-shrink-0">
                                    ${status}
                                    <button class="edit-store-btn text-sm text-blue-600 hover:underline" data-row-index="${report.rowIndex}">修改</button>
                                    <button class="delete-store-btn text-sm text-red-600 hover:underline" data-row-index="${report.rowIndex}">刪除</button>
                                </div>
                            </div>
                        `;
                        $content.append(itemHtml);
                    });
                }
                $('#management-modal').removeClass('hidden');
            });

            $('#close-management-modal').on('click', () => $('#management-modal').addClass('hidden'));

            $('#management-list-content').on('click', '.edit-store-btn', function() {
                const rowIndex = $(this).data('row-index');
                const reportToEdit = rawReports.find(r => r.rowIndex == rowIndex);
                
                if (reportToEdit) {
                    openEditModalForUser(reportToEdit);
                } else {
                    showNotification('找不到地點資料，可能已被刪除或更新。', 'error');
                }
            });

            $('#management-list-content').on('click', '.delete-store-btn', function() {
                const rowIndex = $(this).data('row-index');
                if (window.confirm('確定要刪除這筆您提交的資料嗎？此操作將無法復原。')) {
                    showNotification('正在刪除...');
                    const payload = {
                        action: 'user_delete',
                        rowIndex: rowIndex,
                        userEmail: userProfile.email,
                        lineUserId: userProfile.lineUserId
                    };

                    fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        showNotification("資料已成功刪除！", 'success');
                        $('#management-modal').addClass('hidden');
                        setTimeout(loadData, 2000);
                    }).catch(error => {
                        showNotification('刪除失敗，請稍後再試。', 'error');
                    });
                }
            });

            // --- Review Modal Logic (REFACTORED) ---

            $('#review-btn').on('click', function() {
                $('#review-modal').removeClass('hidden');
                loadReviewData('pending');
                $('#pending-tab').addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');
                $('#approved-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');
            });

            $('#close-review-modal').on('click', () => $('#review-modal').addClass('hidden'));
            
            $('#pending-tab').on('click', function() {
                $(this).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                $('#approved-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                loadReviewData('pending');
            });

            $('#approved-tab').on('click', function() {
                $(this).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                $('#pending-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                loadReviewData('approved');
            });

            function loadReviewData(status = 'pending') {
                const $listPanel = $('#review-list-panel');
                const $detailPanel = $('#review-detail-panel');
                $listPanel.html('');
                $detailPanel.html('<p class="text-gray-500">請從左側列表選擇一個地點以查看詳細資訊。</p>');

                const reportsToReview = rawReports.filter(report => {
                    const isApproved = String(report['審核']).toUpperCase() === 'TRUE';
                    return status === 'pending' ? !isApproved : isApproved;
                });

                if (reportsToReview.length === 0) {
                    $listPanel.html(`<p class="p-4 text-sm text-gray-500">沒有${status === 'pending' ? '待審核' : '已審核'}的地點。</p>`);
                    return;
                }

                reportsToReview.forEach(report => {
                    const listItem = $(`
                        <div class="p-4 border-b cursor-pointer hover:bg-gray-100 review-item" data-row-index="${report.rowIndex}">
                            <p class="font-semibold text-gray-800">${report['地址']}</p>
                            <p class="text-sm text-gray-600 truncate">${report['黑名原因'] || '無原因'}</p>
                            <p class="text-xs text-gray-400 mt-1">提交者: ${report.submitterEmail || report.submitterLineId || 'N/A'}</p>
                        </div>
                    `);
                    $listPanel.append(listItem);
                });
            }

            $('#review-list-panel').on('click', '.review-item', function() {
                $('.review-item').removeClass('bg-indigo-50');
                $(this).addClass('bg-indigo-50');
                const rowIndex = $(this).data('row-index');
                const report = rawReports.find(r => r.rowIndex == rowIndex);
                if (report) {
                    displayReviewDetails(report);
                }
            });

            function displayReviewDetails(report) {
                const $detailPanel = $('#review-detail-panel');
                
                let actionButtons = '';
                const isApproved = String(report['審核']).toUpperCase() === 'TRUE';

                if (!isApproved) { // 待審核
                    actionButtons = `
                        <button class="admin-action-btn flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700" data-action="approve" data-row-index="${report.rowIndex}">審核通過</button>
                        <button class="admin-action-btn flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700" data-action="delete" data-row-index="${report.rowIndex}">不通過</button>
                    `;
                } else { // 已審核
                    actionButtons = `
                        <button class="admin-action-btn flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700" data-action="delete" data-row-index="${report.rowIndex}">刪除</button>
                    `;
                }
                
                const submissionDate = report.timestamp ? 
                    new Date(report.timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : 
                    '日期不明';

                const detailHtml = `
                    <div class="space-y-3 text-sm">
                        <h3 class="text-xl font-bold text-gray-900">${report['地址']}</h3>
                        <p class="font-semibold" style="color: ${categoryColors[report['分類']] || categoryColors['其他']}">${report['分類']}</p>
                        <hr>
                        <p><strong>黑名類別:</strong> ${report['黑名類別']}</p>
                        <p><strong>黑名原因:</strong></p>
                        <p class="whitespace-pre-wrap bg-gray-50 p-2 rounded">${report['黑名原因']}</p>
                        <hr>
                        <p><strong>座標:</strong> ${parseFloat(report['經度']).toFixed(5)}, ${parseFloat(report['緯度']).toFixed(5)}</p>
                        <p><strong>提交者:</strong> ${report.submitterName || 'N/A'} (${report.submitterEmail || report.submitterLineId || 'N/A'})</p>
                        <p><strong>提交時間:</strong> ${submissionDate}</p>
                        <p><strong>試算表列數:</strong> ${report.rowIndex}</p>
                    </div>
                    <div class="mt-6 flex space-x-4">
                        ${actionButtons}
                    </div>
                `;
                $detailPanel.html(detailHtml);
            }
            
            $('#review-detail-panel').on('click', '.admin-action-btn', function() {
                const action = $(this).data('action');
                const rowIndex = $(this).data('row-index');
                
                if (action === 'delete') {
                    if (!window.confirm('確定要刪除這筆資料嗎？此操作將無法復原。')) {
                        return;
                    }
                }
                sendAdminAction(action, rowIndex);
            });
            
            function sendAdminAction(action, rowIndex) {
                showNotification(`正在執行操作...`);

                const payload = {
                    action: action,
                    rowIndex: rowIndex,
                    adminEmail: userProfile.email
                };

                fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .then(() => {
                    showNotification("操作成功！資料將在幾分鐘後更新。", 'success');
                    $('#review-modal').addClass('hidden');
                    setTimeout(loadData, 2000);
                }).catch(error => {
                    showNotification('操作失敗，請稍後再試。', 'error');
                });
            }

            function openEditModalForUser(report) {
                const forms = [$('#add-location-form'), $('#add-location-form-mobile')];
                forms.forEach($f => {
                    $f.find('#edit-row-index').val('');
                    $f.find('#edit-original-name').val(report['地址']);
                    $f.find('#add-address').val(report['地址']);
                    $f.find('#add-category').val(report['分類']);
                    $f.find('#add-blacklist-category').val(report['黑名類別']);
                    $f.find('#add-blacklist-reason').val(report['黑名原因']);
                    $f.closest('div[id^="add-location-modal"]').find('h2').text('修改地點');
                });

                $('#management-modal').addClass('hidden');
                
                const coordinate = ol.proj.fromLonLat([parseFloat(report['經度']), parseFloat(report['緯度'])]);
                if (isMobile) {
                    enterMobilePlacementMode(coordinate);
                    $('#add-location-modal-mobile').removeClass('hidden');
                    $('#complete-placement-btn').addClass('hidden');
                } else {
                    enterDesktopAddMode(coordinate);
                }
            }

            function openEditModalForAdmin(report) {
                const forms = [$('#add-location-form'), $('#add-location-form-mobile')];
                forms.forEach($f => {
                    $f.find('#edit-original-name').val('');
                    $f.find('#edit-row-index').val(report.rowIndex);
                    $f.find('#add-address').val(report['地址']);
                    $f.find('#add-category').val(report['分類']);
                    $f.find('#add-blacklist-category').val(report['黑名類別']);
                    $f.find('#add-blacklist-reason').val(report['黑名原因']);
                    $f.closest('div[id^="add-location-modal"]').find('h2').text('修改地點 (管理員)');
                });

                const coordinate = ol.proj.fromLonLat([parseFloat(report['經度']), parseFloat(report['緯度'])]);
                if (isMobile) {
                    enterMobilePlacementMode(coordinate);
                    $('#add-location-modal-mobile').removeClass('hidden');
                    $('#complete-placement-btn').addClass('hidden');
                } else {
                    enterDesktopAddMode(coordinate);
                }
            }
            
            // --- Initial Load ---
            async function main() {
                const liffId = '2008020548-WdyekkEj';
                
                try {
                    await liff.init({ liffId });
                } catch (e) {
                    console.error('LIFF init failed.', e);
                }

                if (liff.isInClient()) {
                    // 在 LINE 環境中
                    initializeGoogleButton(true); // 渲染自訂的 Google 登入按鈕

                    if (liff.isLoggedIn()) {
                        // 已透過 LINE 登入
                        $('#google-signin-container').hide();
                        $('#line-login-container').hide();
                        const lineProfile = await liff.getProfile();
                        await handleLineLogin(lineProfile);
                    } else {
                        // 尚未登入，顯示 LINE 和 Google 登入選項
                        $('#google-signin-container').show();
                        $('#line-login-container').show();
                        $('#line-login-btn').on('click', () => liff.login());
                    }
                } else {
                    // 不在 LINE 環境中
                    $('#line-login-container').hide();
                    initializeGoogleButton(false); // 渲染真正的 Google 登入按鈕
                    await verifyToken();
                }

                loadUserVotes();
                initializeUserLocation();
                
                // 新增：當視窗重新獲得焦點時（例如從 LIFF 視窗回來），檢查登入狀態
                window.addEventListener('focus', () => {
                    // 只在未登入狀態下才重新檢查，避免重複執行
                    if (!isLoggedIn) {
                        verifyToken();
                    }
                });
            }

            main();
        };
    </script>
</body>
</html>

