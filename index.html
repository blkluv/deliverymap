// --- 全域常數設定 (僅存於後端) ---
const SPREADSHEET_ID = "1FRew2nM89vpsdoNL_HAA0RIDDPh2J-aGCkO8HVbCvgw"; 
const SHEET_NAME = "資料回報";
const DELETED_SHEET_NAME = "刪除紀錄";
const ADMIN_SHEET_GID = "1217747313"; // 管理員名單 GID
const TIMEZONE = "Asia/Taipei";

/**
 * @description 處理 GET 請求 (讀取資料)
 * @param {Object} e - 事件物件，包含 URL 參數
 */
function doGet(e) {
  try {
    const action = e.parameter.action;

    if (action === 'getData') {
      const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
      const data = sheet.getDataRange().getValues();
      const headers = data.shift(); // 取出標題列
      
      // 將二維陣列轉換為物件陣列 (JSON)
      const jsonData = data.map((row, index) => {
        let obj = {};
        headers.forEach((header, i) => {
          obj[header] = row[i];
        });
        // **重要：將試算表中的實際列數加入資料中**
        obj.rowIndex = index + 2; // +2 是因為陣列索引從0開始，且第一列是標題
        return obj;
      });
      
      return createJsonResponse(jsonData);
    }

    if (action === 'checkAdmin' && e.parameter.email) {
      const isAdmin = isUserAdmin(e.parameter.email);
      return createJsonResponse({ isAdmin: isAdmin });
    }

    return createJsonResponse({ status: 'error', message: 'Invalid GET action.' });

  } catch (error) {
    return createJsonResponse({ status: 'error', message: error.toString() });
  }
}


/**
 * @description 處理 POST 請求 (寫入/修改資料)
 * @param {Object} e - 事件物件，包含 POST 過來的資料
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action || 'create'; 
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);

    // --- 伺服器端管理員權限驗證 ---
    if (['approve', 'delete', 'admin_modify'].includes(action)) {
      if (!isUserAdmin(data.adminEmail)) {
        return createJsonResponse({ "status": "error", "message": "Permission denied." });
      }
    }

    // --- 根據 action 執行不同邏輯 ---
    if (action === 'vote') return handleVote(sheet, data); // NEW: Handle vote action
    if (action === 'update') return handleUserUpdate(sheet, data);
    if (action === 'create') return handleCreate(sheet, data);
    if (data.rowIndex && data.rowIndex > 1) {
      switch (action) {
        case 'approve': return handleApprove(sheet, data);
        case 'delete': return handleDelete(sheet, data);
        case 'admin_modify': return handleAdminModify(sheet, data);
      }
    }
    
    return createJsonResponse({ "status": "error", "message": "Invalid action or missing rowIndex." });

  } catch (error) {
    return createJsonResponse({ "status": "error", "message": error.toString() });
  }
}

// --- 處理各項操作的輔助函數 ---

// NEW: Function to handle voting
function handleVote(sheet, data) {
  try {
    const lock = LockService.getScriptLock();
    lock.waitLock(15000); // Wait up to 15 seconds for lock

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const headerMap = createHeaderMap(headers);
    
    const voteType = data.voteType; // 'like' or 'dislike'
    const change = parseInt(data.change, 10) || 0;
    const rowIndex = parseInt(data.rowIndex, 10);

    if (!rowIndex || !voteType || !['like', 'dislike'].includes(voteType) || change === 0) {
      return createJsonResponse({ "status": "error", "message": "Invalid vote data." });
    }

    const columnToUpdate = voteType === 'like' ? 'likes' : 'dislikes';
    const colIndex = headerMap[columnToUpdate];

    if (colIndex === undefined) {
      return createJsonResponse({ "status": "error", "message": `Column '${columnToUpdate}' not found.` });
    }

    const cell = sheet.getRange(rowIndex, colIndex + 1);
    const currentValue = parseInt(cell.getValue(), 10) || 0;
    const newValue = currentValue + change;
    
    cell.setValue(newValue);

    lock.releaseLock();
    return createJsonResponse({ "status": "success", "message": "Vote recorded.", "newValue": newValue });

  } catch (e) {
    return createJsonResponse({ "status": "error", "message": "Failed to record vote: " + e.toString() });
  }
}


function handleApprove(sheet, data) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const headerMap = createHeaderMap(headers);
  const approveColIndex = headerMap['審核'];
  
  if (approveColIndex !== undefined) {
    sheet.getRange(data.rowIndex, approveColIndex + 1).setValue(true);
    return createJsonResponse({ "status": "success", "message": "Store approved." });
  }
  return createJsonResponse({ "status": "error", "message": "Could not find '審核' column." });
}

function handleDelete(sheet, data) {
  const deletedSheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(DELETED_SHEET_NAME) || SpreadsheetApp.openById(SPREADSHEET_ID).insertSheet(DELETED_SHEET_NAME);
  const rowData = sheet.getRange(data.rowIndex, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  const formattedTimestamp = Utilities.formatDate(new Date(), TIMEZONE, "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");
  rowData.push(`由 ${data.adminEmail} 於 ${formattedTimestamp} 刪除`);
  
  if (deletedSheet.getLastRow() === 0) {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    deletedSheet.appendRow([...headers, "刪除資訊"]);
  }
  
  deletedSheet.appendRow(rowData);
  sheet.deleteRow(data.rowIndex);
  return createJsonResponse({ "status": "success", "message": "Store deleted." });
}

function handleAdminModify(sheet, data) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const headerMap = createHeaderMap(headers);
  const originalValues = sheet.getRange(data.rowIndex, 1, 1, headers.length).getValues()[0];
  const formattedTimestamp = Utilities.formatDate(new Date(), TIMEZONE, "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");

  const newRowData = headers.map(header => {
    switch(header) {
      case '分類': return data.category;
      case '地址': return data.address;
      case '黑名類別': return data.blacklistCategory;
      case '黑名原因': return data.blacklistReason;
      case '經度': return data.lon;
      case '緯度': return data.lat;
      case '審核': return true;
      case '最後修改': return `由 ${data.adminEmail} 於 ${formattedTimestamp} 修改`;
      case 'timestamp': return data.timestamp || formattedTimestamp;
      default: 
        return originalValues[headerMap[header]];
    }
  });
  sheet.getRange(data.rowIndex, 1, 1, newRowData.length).setValues([newRowData]);
  return createJsonResponse({ "status": "success", "message": "Admin updated store." });
}

function handleUserUpdate(sheet, data) {
  const values = sheet.getDataRange().getValues();
  const headers = values[0];
  const headerMap = createHeaderMap(headers);
  const emailCol = headerMap['submitterEmail'];
  const nameCol = headerMap['地址']; 
  const formattedTimestamp = Utilities.formatDate(new Date(), TIMEZONE, "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");

  for (let i = 1; i < values.length; i++) {
    if (values[i][emailCol] == data.submitterEmail && values[i][nameCol] == data.originalName) {
      const userUpdateRowIndex = i + 1;
      const newRowData = headers.map(header => {
         switch(header) {
           case 'timestamp': return data.timestamp || formattedTimestamp;
           case '分類': return data.category;
           case '地址': return data.address;
           case '黑名類別': return data.blacklistCategory;
           case '黑名原因': return data.blacklistReason;
           case '經度': return data.lon;
           case '緯度': return data.lat;
           case '審核': return false; 
           default: 
             return values[i][headerMap[header]];
         }
      });
      sheet.getRange(userUpdateRowIndex, 1, 1, newRowData.length).setValues([newRowData]);
      return createJsonResponse({ "status": "success", "message": "User updated store." });
    }
  }
  return createJsonResponse({ "status": "error", "message": "Row not found for user update." });
}

function handleCreate(sheet, data) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const formattedTimestamp = Utilities.formatDate(new Date(), TIMEZONE, "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");
  const newRow = headers.map(header => {
      switch(header) {
          case 'timestamp': return data.timestamp || formattedTimestamp;
          case 'submitterName': return data.submitterName;
          case 'submitterEmail': return data.submitterEmail;
          case '分類': return data.category;
          case '地址': return data.address;
          case '黑名類別': return data.blacklistCategory;
          case '黑名原因': return data.blacklistReason;
          case '經度': return data.lon;
          case '緯度': return data.lat;
          case '審核': return false;
          case 'likes': return 0; // Initialize with 0
          case 'dislikes': return 0; // Initialize with 0
          default: return "";
      }
  });
  sheet.appendRow(newRow);
  return createJsonResponse({ "status": "success", "message": "New row added." });
}

// --- 通用工具函數 ---

/** @description 檢查指定 email 是否為管理員 */
function isUserAdmin(email) {
  if (!email) return false;
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = ss.getSheets();
    const adminSheet = sheets.find(sheet => sheet.getSheetId() == ADMIN_SHEET_GID);

    if (adminSheet) {
      const adminEmails = adminSheet.getRange("A:A").getValues().flat().map(e => e.trim());
      return adminEmails.includes(email.trim());
    }
    return false;
  } catch (error) {
    return false;
  }
}

function createHeaderMap(headers) {
  const map = {};
  headers.forEach((header, index) => { map[header] = index; });
  return map;
}

function createJsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
