<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑客指南針</title>
    
    <!-- LIFF SDK (新增，供 liff.openWindow 使用) -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- NEW: Script to detect Facebook browser and show overlay -->
    <script>
        (function() {
            const ua = navigator.userAgent.toLowerCase();
            const isFacebookApp = ua.indexOf("fban") > -1 || ua.indexOf("fbav") > -1;

            // 只在 Facebook App 中執行
            if (isFacebookApp) {
                // 等待 DOM 載入完成後再顯示提示，確保元素存在
                document.addEventListener('DOMContentLoaded', function() {
                    const modal = document.getElementById('facebook-blocker-modal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                });
            }
        })();
    </script>

    <!-- Script to clean URL parameters from Facebook, etc. -->
    <script>
        (function() {
            const url = new URL(window.location);
            if (url.searchParams.has('fbclid')) {
                const newUrl = url.pathname + url.hash;
                window.history.replaceState({}, document.title, newUrl);
            }
        })();
    </script>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- NEW: Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    
    <!-- MODIFIED: pinyin-pro for Chinese to Pinyin conversion -->
    <script src="https://unpkg.com/pinyin-pro@3.18.2/dist/index.js"></script>

    <!-- NEW: External Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- NEW: Additional styles for context menu -->
    <style>
        .chat-message-item {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        /* --- BEGIN MODIFICATION: Mobile Grid Submit Button Styles --- */
        #mobile-grid-submit-btn {
            position: absolute;
            bottom: var(--mobile-bottom-offset, 6rem);
            right: 1rem;
            z-index: 20;
            background-color: #ef4444; /* red-500 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 14px 0 rgba(0,0,0,0.25);
            transition: background-color 0.2s;
        }
        #mobile-grid-submit-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        /* --- END MODIFICATION --- */
    </style>

</head>
<body class="bg-gray-100">

    <div id="app" class="relative h-screen w-screen overflow-hidden">
        <!-- App Container -->
        <div id="app-container">
            <!-- 新增/編輯店家 Modal (Desktop Sidebar) -->
            <div id="add-location-modal" class="desktop-mode">
                <div class="bg-white shadow-2xl w-full h-full flex flex-col">
                    <form id="add-location-form" class="flex-grow flex flex-col overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                            <h2 id="modal-title" class="text-xl font-bold text-gray-800">新增地點</h2>
                            <div class="flex items-center space-x-2">
                                 <button id="submit-location-btn" type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center w-28">
                                    <span class="submit-text">送出審核</span>
                                    <span class="spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                                 </button>
                                <button id="close-add-location-modal" type="button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                            </div>
                        </div>
                        <div class="px-6 pt-2 pb-16 space-y-4 overflow-y-auto custom-scrollbar flex-grow">
                            <input type="hidden" id="edit-row-index" name="rowIndex">
                            <input type="hidden" id="edit-area-row-index" name="areaRowIndex">
                            <input type="hidden" id="edit-original-name" name="originalName">
                            <p id="location-instruction" class="text-sm text-gray-600">請移動地圖中心點來選擇位置。</p>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">社區/區域名稱</label>
                                <input type="text" id="add-area-name" name="areaName" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">地址 <span class="text-red-500">*</span></label>
                                <div id="address-input-container">
                                    <input type="text" id="add-address" name="address" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">類別 <span class="text-red-500">*</span></label>
                                <select id="add-category" name="category" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" required></select>
                            </div>
                            <div class="hidden md:block">
                                <label class="flex items-center mt-2">
                                    <input type="checkbox" id="add-is-area" name="isArea" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">標示為整個社區/區域</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">勾選後，可點擊地圖上的網格來標示範圍。</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">黑名類別</label>
                                <select id="add-blacklist-category" name="blacklistCategory" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="" disabled selected>請選擇...</option>
                                    <option value="黑客">黑客</option>
                                    <option value="送上樓">送上樓</option>
                                    <option value="需爬梯">需爬梯</option>
                                    <option value="拖吊">拖吊</option>
                                    <option value="騙餐">騙餐</option>
                                    <option value="奇怪">奇怪</option>
                                    <option value="性騷擾">性騷擾</option>
                                    <option value="店家">店家</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">黑名原因</label>
                                <textarea id="add-blacklist-reason" name="blacklistReason" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Map Container -->
            <main id="map-container" class="w-full h-full relative">
                <div id="map"></div>
                <canvas id="grid-canvas"></canvas>

                <div id="grid-toolbar" class="hidden">
                    <button id="tool-pan" class="grid-tool-btn" title="移動畫面">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0 .075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 0 1 3.15 0V15M6.9 7.575a1.575 1.575 0 1 0-3.15 0v8.175a6.75 6.75 0 0 0 6.75 6.75h2.018a5.25 5.25 0 0 0 3.712-1.538l1.732-1.732a5.25 5.25 0 0 0 1.538-3.712l.003-2.024a.668.668 0 0 1 .198-.471 1.575 1.575 0 1 0-2.228-2.228 3.818 3.818 0 0 0-1.12 2.687M6.9 7.575V12m6.27 4.318A4.49 4.49 0 0 1 16.35 15m.002 0h-.002" />
                        </svg>
                    </button>
                    <div class="w-px h-6 bg-gray-300"></div>
                    <button id="tool-fill" class="grid-tool-btn active" title="填色">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
                        </svg>
                    </button>
                    <button id="tool-eraser" class="grid-tool-btn" title="擦除">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z" />
                        </svg>
                    </button>
                    <div id="marker-tools">
                        <button id="tool-entrance" class="grid-tool-btn font-bold text-lg" title="入口">入</button>
                        <button id="tool-exit" class="grid-tool-btn font-bold text-lg" title="出口">出</button>
                        <button id="tool-table" class="grid-tool-btn font-bold text-lg" title="外送桌">桌</button>
                        <button id="tool-parking" class="grid-tool-btn font-bold text-lg" title="停車位置">停</button>
                    </div>
                </div>

                <div id="grid-color-palette" class="hidden absolute top-20 z-20 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-lg flex flex-row items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <label class="block text-sm font-medium text-gray-700">格子</label>
                        <input type="color" id="palette-fill-color" value="#ef4444" class="w-8 h-8 p-0 border-none rounded cursor-pointer" style="appearance: none; -webkit-appearance: none; background-color: transparent;">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="block text-sm font-medium text-gray-700">標記</label>
                        <input type="color" id="palette-marker-color" value="#000000" class="w-8 h-8 p-0 border-none rounded cursor-pointer" style="appearance: none; -webkit-appearance: none; background-color: transparent;">
                    </div>
                </div>
                
                <div id="notification" class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-yellow-500 text-white text-sm py-2 px-4 rounded-lg shadow-lg hidden transition-all duration-300">
                    訊息
                </div>

                <div id="popup" class="ol-popup">
                    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                    <div id="popup-content"></div>
                </div>
                
                <div id="user-location" class="absolute w-4 h-4 -translate-x-1/2 -translate-y-1/2 hidden">
                    <div class="w-full h-full rounded-full bg-blue-600 border-2 border-white shadow-md pulse-dot"></div>
                </div>
                
                <div id="desktop-center-marker" class="hidden">
                     <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ef4444' width='40px' height='40px'><path d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/></svg>" alt="Center Marker">
                </div>
                
                <div id="search-panel" class="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-lg w-[90%] max-w-md hidden">
                    <div class="relative">
                        <input type="text" id="search-address-input" placeholder="輸入地址或關鍵字搜尋..." class="w-full p-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <button id="close-search-panel" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="main-action-buttons" class="absolute top-4 right-4 z-10 flex flex-col items-end space-y-2">
                    <div id="login-status">
                        <div id="google-signin-container" style="display: none;"></div>
                        
                         <div id="add-info" class="bg-white text-gray-700 py-2 px-4 rounded-lg shadow-lg items-center space-x-2 hidden">
                            <img id="user-picture" src="" alt="使用者頭像" class="w-6 h-6 rounded-full mr-2 hidden">
                            <span id="user-name" class="font-bold"></span>
                            <button id="edit-nickname-btn" class="text-xs text-blue-500 hover:underline">[修改]</button>
                            <button id="manage-btn" class="text-sm text-blue-600 hover:underline">管理</button>
                            <button id="review-btn" class="text-sm text-red-600 hover:underline hidden">審核</button>
                            <a href="#" id="sign-out-btn" class="text-xs text-gray-500 hover:underline ml-2">登出</a>
                        </div>
                    </div>
                    <button id="search-address-btn" class="bg-white text-gray-700 p-3 rounded-lg shadow-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center" title="搜尋地址">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="open-filter-modal" class="bg-blue-600 text-white p-3 rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center" title="篩選">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                     <button id="center-on-me-btn" class="bg-white text-gray-700 p-3 rounded-lg shadow-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center" title="回到我的位置">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                    <button id="open-chat-btn" class="relative bg-white text-gray-700 p-3 rounded-lg shadow-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center" title="聊天室">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
                        </svg>
                        <span id="chat-unread-badge" class="hidden absolute -top-1 -right-1 bg-green-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center"></span>
                    </button>
                    <button id="add-location-btn" class="bg-white text-gray-700 p-3 rounded-lg shadow-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center" title="新增地點">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>


                <div id="legend" class="absolute left-1/2 -translate-x-1/2 z-10 bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-md">
                    <div id="legend-content" class="flex items-center justify-center flex-wrap gap-x-4 gap-y-1 text-xs md:text-sm">
                    </div>
                </div>
                
                <div id="store-list-panel" class="absolute left-4 w-64 z-10 bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-md flex flex-col transition-all duration-300 ease-in-out" style="max-height: 14rem;">
                    <div class="flex justify-between items-start flex-shrink-0 mb-2">
                        <div id="store-list-filters" class="flex-grow flex overflow-x-auto pb-1 custom-scrollbar">
                        </div>
                    </div>
                    <div id="store-list-content" class="flex-grow overflow-y-auto custom-scrollbar pr-2 transition-all duration-300">
                    </div>
                </div>
                
                <button id="complete-placement-btn" class="hidden absolute top-20 right-20 z-20 bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition-colors">
                    完成位置設定
                </button>
                
                <button id="restore-modal-btn" class="hidden absolute top-1/2 -translate-y-1/2 -left-1 z-20 bg-white p-2 rounded-r-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <button id="restore-mobile-modal-btn" class="hidden absolute top-1/2 -translate-y-1/2 -left-1 z-30 bg-white p-2 rounded-r-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <!-- --- BEGIN MODIFICATION: Added Mobile Grid Submit Button --- -->
                <button id="mobile-grid-submit-btn" class="hidden">送出</button>
                <!-- --- END MODIFICATION --- -->

            </main>
        </div>

        <!-- 新增/編輯店家 Modal (Mobile Popup) -->
        <div id="add-location-modal-mobile" class="hidden fixed inset-0 z-[60] flex items-start justify-center p-4 pt-12 sm:items-center sm:pt-4 overflow-hidden">
             <div class="bg-white shadow-2xl w-full max-w-md rounded-lg flex flex-col transition-transform duration-300 ease-in-out" style="max-height: calc(100vh - 5rem);">
                <form id="add-location-form-mobile" class="flex-grow flex flex-col overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                        <button type="button" id="minimize-mobile-modal-btn" class="hidden text-gray-400 hover:text-gray-600 p-2 -ml-2 mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div id="mobile-modal-title-container" class="flex-grow">
                             <div class="flex border-b border-gray-200">
                                <button type="button" id="mobile-add-point-tab" class="mobile-add-tab active py-2 px-4 text-sm font-medium text-center text-indigo-600 bg-indigo-50 rounded-t-lg">新增地點</button>
                                <button type="button" id="mobile-add-area-tab" class="mobile-add-tab py-2 px-4 text-sm font-medium text-center text-gray-500 hover:text-gray-700">新增建築</button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 pl-2">
                             <button id="submit-location-btn-mobile" type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center w-28">
                                <span class="submit-text">送出審核</span>
                                <span class="spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                            </button>
                            <button id="close-add-location-modal-mobile" type="button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                        </div>
                    </div>
                    <div class="px-6 pt-2 pb-16 space-y-4 overflow-y-auto custom-scrollbar flex-grow">
                       <div id="mobile-point-fields">
                       </div>
                       <div id="mobile-area-fields" class="hidden">
                       </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 篩選 Modal -->
        <div id="filter-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">篩選</h2>
                    <button id="close-filter-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <div class="mb-4">
                        <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">分類</label>
                        <select id="category-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">所有分類</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="keyword-search" class="block text-sm font-medium text-gray-700 mb-1">關鍵字搜尋</label>
                        <input type="text" id="keyword-search" placeholder="地址、關鍵字" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="p-6 bg-gray-50 border-t rounded-b-lg flex space-x-2">
                    <button id="filter-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        套用篩選
                    </button>
                    <button id="reset-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        重設
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 公司產品 Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 id="product-modal-title" class="text-xl font-bold text-gray-800">黑名原因</h2>
                    <button id="close-product-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div id="product-modal-content" class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar whitespace-pre-wrap"></div>
            </div>
        </div>

        <!-- Management Modal -->
        <div id="management-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="height: 80vh;">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">我的貢獻管理</h2>
                    <button id="close-management-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                        <button id="manage-locations-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">我的地點</button>
                        <button id="manage-areas-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">我的建築</button>
                    </nav>
                </div>
                <div class="flex-grow overflow-y-auto custom-scrollbar">
                    <div id="management-list-content" class="p-6">
                    </div>
                    <div id="management-area-content" class="p-6 hidden">
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div id="review-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl flex flex-col" style="height: 90vh;">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">審核地點</h2>
                    <div class="flex items-center space-x-2">
                        <button id="review-refresh-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="重新整理">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l16 16" transform="rotate(90 12 12)"></path>
                            </svg>
                        </button>
                        <button id="close-review-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                </div>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                        <button id="pending-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">待審核</button>
                        <button id="approved-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">已審核/已駁回</button>
                    </nav>
                </div>
                <div class="flex-grow overflow-y-hidden flex">
                    <div id="review-list-panel" class="w-1/3 border-r overflow-y-auto custom-scrollbar bg-gray-50">
                    </div>
                    <div id="review-detail-panel" class="w-2/3 p-6 overflow-y-auto custom-scrollbar">
                        <p class="text-gray-500">請從左側列表選擇一個地點以查看詳細資訊。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Modal -->
        <div id="chat-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col" style="height: 70vh;">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">外送員聊天室</h2>
                    <div class="flex items-center space-x-4">
                         <label class="flex items-center text-sm text-gray-600 cursor-pointer">
                            <input type="checkbox" id="hide-system-msgs-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 whitespace-nowrap">隱藏系統訊息</span>
                         </label>
                        <button id="close-chat-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                </div>
                <div id="chat-messages" class="flex-grow p-4 overflow-y-auto custom-scrollbar flex flex-col space-y-2 bg-gray-50">
                </div>
                <div class="p-4 bg-white border-t">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="chat-input" placeholder="輸入訊息..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="send-chat-btn" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- In-App Browser Blocker for Facebook -->
        <div id="facebook-blocker-modal" class="fixed inset-0 bg-black/80 z-[200] flex-col items-center justify-center p-8 text-white text-center hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-2xl font-bold mb-4">功能可能受限</h2>
            <p class="text-lg">
                您似乎正在使用 Facebook 內建瀏覽器。
                <br><br>
                為了獲得最佳體驗，建議您點擊畫面右上角的「<span class="font-bold">•••</span>」選單，然後選擇「<span class="font-bold">在瀏覽器中開啟</span>」。
            </p>
        </div>
    </div>

    <!-- NEW: Chat Context Menu -->
    <div id="chat-context-menu" class="hidden absolute z-[100] bg-white rounded-md shadow-lg py-1 w-32">
        <a href="#" id="context-private-msg" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">私訊</a>
        <a href="#" id="context-mute-user" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 admin-only">禁言</a>
    </div>

    <!-- NEW: Mute User Modal -->
    <div id="mute-user-modal" class="fixed inset-0 bg-black/50 z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <form id="mute-user-form">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-bold text-gray-800">禁言使用者</h2>
                    <p class="text-sm text-gray-500 mt-1">您正準備禁言 <span id="mute-user-name" class="font-semibold"></span></p>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">天數</label>
                        <input type="number" id="mute-days" min="0" value="0" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">分鐘</label>
                        <input type="number" id="mute-minutes" min="0" value="10" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t rounded-b-lg flex justify-end space-x-2">
                    <button type="button" id="cancel-mute-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                    <button type="submit" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">確認禁言</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // This function needs to be in the global scope for the Google API to call it.
        function handleCredentialResponse(response) {
            // Decode the JWT to get user profile
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            const profile = JSON.parse(jsonPayload);
            
            const event = new CustomEvent('google-signin-success', { detail: profile });
            window.dispatchEvent(event);
        }
        // Make it globally accessible
        window.handleCredentialResponse = handleCredentialResponse;
    </script>
    
<script type="module">
  // --- Grid Mode Map Filter Settings ---
  const MAP_FILTER_CONTRAST = 1;
  const MAP_FILTER_SATURATE = 1;
  const MAP_FILTER_BRIGHTNESS = 1;
  const LABEL_VISIBILITY_ZOOM = 17; 

  document.documentElement.style.setProperty('--map-filter-style', 
    `contrast(${MAP_FILTER_CONTRAST}) saturate(${MAP_FILTER_SATURATE}) brightness(${MAP_FILTER_BRIGHTNESS})`
  );
        
        // --- OpenLayers 地圖設定 ---
        const categoryColors = {
            '透天厝': 'rgba(1, 196, 106, 1)',
            '公寓大廈': 'rgba(247, 41, 128, 1)',
            '辦公室': 'rgba(59, 130, 246, 1)',
            '飯店': 'rgba(139, 92, 246, 1)',
            '其他': 'rgba(107, 114, 128, 1)',
        };
        const allCategories = ['透天厝', '公寓大廈', '辦公室', '飯店', '其他'];

        const mapIcons = {
            '透天厝': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['透天厝']}" stroke="white" stroke-width="1.5"/><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="white"/></svg>`)}`,
            '公寓大廈': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['公寓大廈']}" stroke="white" stroke-width="1.5"/><g transform="scale(0.7) translate(5.5, 3.5)"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" fill="none" stroke-width="1.8" stroke="white"/></g></svg>`)}`,
            '辦公室': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['辦公室']}" stroke="white" stroke-width="1.5"/><g transform="scale(0.7) translate(5.2, 3.5)"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z" fill="white"/></g></svg>`)}`,
            '飯店': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['飯店']}" stroke="white" stroke-width="1.5"/><g transform="scale(0.7) translate(5.2, 3.5)"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2V7c0-2.21-1.79-4-4-4z" fill="white"/></g></svg>`)}`,
            '其他': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28px" height="28px"><circle cx="12" cy="12" r="11" fill="${categoryColors['其他']}" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`)}`
        };
        
        const legendIcons = {
            '透天厝': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['透天厝']}" width="28px" height="28px"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`)}`,
            '公寓大廈': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="${categoryColors['公寓大廈']}" width="28px" height="28px"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" /></svg>`)}`,
            '辦公室': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['辦公室']}" width="28px" height="28px"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>`)}`,
            '飯店': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['飯店']}" width="28px" height="28px"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2V7c0-2.21-1.79-4-4-4z"/></svg>`)}`,
            '其他': `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${categoryColors['其他']}" width="24px" height="24px"><circle cx="12" cy="12" r="8"/></svg>`)}`
        };
        
        const clusterColorPalette = [
            'rgba(2, 132, 199, 0.8)', 'rgba(217, 70, 239, 0.8)', 'rgba(249, 115, 22, 0.8)',
            'rgba(132, 204, 22, 0.8)', 'rgba(168, 85, 247, 0.8)', 'rgba(239, 68, 68, 0.8)',
        ];

        const styleCache = {};
        let middleMouseButtonPan = null;

        const osmLayer = new ol.layer.Tile({
            source: new ol.source.OSM({
                 attributions: '內容為外送員分享經驗 | 地圖資料 &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> 貢獻者',
            }),
            zIndex: 0 
        });
        
        const areaGridSource = new ol.source.Vector();
        const areaGridLayer = new ol.layer.Vector({
            source: areaGridSource,
            style: function(feature) {
                return feature.getStyle();
            },
            zIndex: 1 
        });

        const vectorSource = new ol.source.Vector();
        const clusterSource = new ol.source.Cluster({ distance: 50, minDistance: 25, source: vectorSource });

        const lineSource = new ol.source.Vector();
        const lineLayer = new ol.layer.Vector({
            source: lineSource,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(50, 50, 50, 0.7)',
                    width: 1.5,
                    lineDash: [4, 4]
                })
            }),
            zIndex: 2 
        });
        
        const radiusSource = new ol.source.Vector();
        const radiusLayer = new ol.layer.Vector({
            source: radiusSource,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(59, 130, 246, 0.1)',
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(59, 130, 246, 0.8)',
                    width: 2,
                }),
            }),
            zIndex: 2 
        });

        function formatAddress(address) {
            if (!address) return '';
            const match = address.match(/([^縣市區鄉鎮鎮]+(?:路|街|大道|巷|村|里).*)/);
            return match ? match[1] : address;
        }

        function clusterStyleFunction(feature) {
            const features = feature.get('features');
            const size = features.length;
            
            if (size > 1) {
                const styleKey = `cluster_${size}`;
                if (!styleCache[styleKey]) {
                    const colorIndex = (size * 5) % clusterColorPalette.length;
                    const clusterColor = clusterColorPalette[colorIndex];
                    styleCache[styleKey] = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 12 + Math.min(size, 20),
                            fill: new ol.style.Fill({ color: clusterColor }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                        }),
                        text: new ol.style.Text({ text: size.toString(), fill: new ol.style.Fill({ color: '#fff' }), font: 'bold 12px sans-serif' }),
                    });
                }
                return styleCache[styleKey];
            } else {
                const originalFeature = features[0];
                const category = originalFeature.get('category') || '其他';
                const singleStyleKey = `single_${category}`;
                
                if (!styleCache[singleStyleKey]) {
                     styleCache[singleStyleKey] = new ol.style.Style({
                        image: new ol.style.Icon({
                            src: mapIcons[category] || mapIcons['其他'],
                            scale: 1,
                            anchor: [0.5, 1],
                        })
                    });
                }

                const clonedStyle = styleCache[singleStyleKey].clone();
                const resolution = map.getView().getResolution();

                if (resolution <= 50) {
                    const shortAddress = formatAddress(originalFeature.get('address'));
                    clonedStyle.setText(new ol.style.Text({
                        text: shortAddress, 
                        font: 'bold 13px sans-serif', 
                        fill: new ol.style.Fill({ color: '#333' }),
                        backgroundFill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.85)' }),
                        backgroundStroke: new ol.style.Stroke({ color: categoryColors[category] || categoryColors['其他'], width: 1 }),
                        padding: [5, 7, 5, 7], 
                        offsetY: 8,
                        overflow: true,
                    }));
                }
                return clonedStyle;
            }
        }

        const clusterLayer = new ol.layer.Vector({ 
            source: clusterSource, 
            style: clusterStyleFunction,
            zIndex: 3 
        });
        
        const taiwanExtent = ol.proj.transformExtent([118.0, 21.5, 122.5, 25.5], 'EPSG:4326', 'EPSG:3857');

        const map = new ol.Map({
            target: 'map', 
            layers: [osmLayer, areaGridLayer, lineLayer, radiusLayer, clusterLayer],
            // --- BEGIN MODIFICATION: Disable double click zoom ---
            interactions: ol.interaction.defaults({
                doubleClickZoom: false,
            }),
            // --- END MODIFICATION ---
            view: new ol.View({ 
                center: ol.proj.fromLonLat([120.9, 23.9]), 
                zoom: 8,
                extent: taiwanExtent,
                minZoom: 8,
            }),
            controls: [
                new ol.control.Zoom(),
                new ol.control.Rotate(),
                new ol.control.Attribution({
                    collapsible: false
                })
            ]
        });

        const popupContainer = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const popupCloser = document.getElementById('popup-closer');

        const infoOverlay = new ol.Overlay({
            element: popupContainer,
            autoPan: { animation: { duration: 250 } },
        });
        map.addOverlay(infoOverlay);
        
        $('#app').on('touchend click', '#popup-closer', function(e) {
            e.preventDefault();
            infoOverlay.setPosition(undefined);
            this.blur();
        });
        
        const userLocationElement = document.getElementById('user-location');
        let userPositionCoords = null;
        const userLocationOverlay = new ol.Overlay({ element: userLocationElement, positioning: 'center-center', stopEvent: false });
        map.addOverlay(userLocationOverlay);

        window.onload = function() {
            const { pinyin } = pinyinPro; 
            const isLineApp = navigator.userAgent.toLowerCase().indexOf("line") > -1;
            
            if (isLineApp) {
                document.documentElement.style.setProperty('--mobile-bottom-offset', '4rem');
            }

            let allFeatures = [];
            let rawReports = [];
            let fuse = null; 
            let isLoggedIn = false;
            let userProfile = {};
            let isAdmin = false; 
            const isMobile = window.innerWidth < 768;
            
            let initialAddLocationCoords = null;
            let tempMarker = null;
            let isDraggingMarker = false;
            let latestGeocodeBounds = null;
            let areaBoundsForEditing = null;
            let lockedCenterForEditing = null;
            
            const gridCanvas = document.getElementById('grid-canvas');
            const gridCtx = gridCanvas.getContext('2d');
            let isAreaSelectionMode = false;
            
            const GRID_INTERVAL = 0.000033;
            const GRID_PRECISION = 6;
            const GRID_DRAW_RADIUS = 5000; 
            const GRID_ZOOM_LEVEL_WEB = 20; 
            const GRID_ZOOM_LEVEL_MOBILE = 19;
            
            let selectedGridCells = new Map();
            let currentAreaColor = 'rgba(239, 68, 68, 0.7)';
            let currentMarkerColor = '#000000';
            let currentAreaTool = 'fill';
            
            let isDrawingOnGrid = false;
            let lastPaintedCellKey = null;

            let dragPanInteraction;
            let reviewMapInstance = null;
            let managementAreaMaps = {};

            let cachedActionButtons = null;

            map.getInteractions().forEach(interaction => {
                if (interaction instanceof ol.interaction.DragPan) {
                    dragPanInteraction = interaction;
                }
            });

            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw93ckEaMhqOmcrsGiMFY3gkxQVLDlKItY_O-xmEaswKibQ8YlscrVjHuB2viTV0XZg/exec';
            const CHAT_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzr_Xmv4WeUCDOjpZmXdHLwtWg4kAOhcMB0brJQWkzquFqOLjupnFcB7AvdQM022dqWrQ/exec';
            const MAIN_APPS_SCRIPT_URL = '';

            const visibilityThreshold = 16.5; 

            let currentFeatureData = null;
            let userVotes = {};
            let currentUserDisplayName = '';
            let currentUserCity = '未知區域';
            const VOTES_STORAGE_KEY = 'userBlacklistVotes';
            const SESSION_TOKEN_KEY = 'userSessionToken';
            let loginCheckInterval = null;
            let ws = null;
            let heartbeatInterval = null;
            let isLocationKnown = false;
            let unreadChatCount = 0;
            let isChatHistoryLoaded = false;
            let contextMenuTarget = { userId: null, userName: null };

            function loadUserVotes() {
                try {
                    const storedVotes = localStorage.getItem(VOTES_STORAGE_KEY);
                    userVotes = storedVotes ? JSON.parse(storedVotes) : {};
                } catch (e) {
                    console.error("Could not load user votes:", e);
                    userVotes = {};
                }
            }

            function saveUserVotes() {
                try {
                    localStorage.setItem(VOTES_STORAGE_KEY, JSON.stringify(userVotes));
                } catch (e) {
                    console.error("Could not save user votes:", e);
                }
            }
            
            async function loadArchivedChatHistory() {
                if (!isLoggedIn || !CHAT_APPS_SCRIPT_URL.startsWith('https')) {
                    return;
                }
                console.log("正在從 Google Sheet 載入歷史訊息...");
                try {
                    const response = await fetch(`${CHAT_APPS_SCRIPT_URL}?action=get_chat_history&t=${new Date().getTime()}`);
                    const history = await response.json();
                    
                    if (Array.isArray(history) && history.length > 0) {
                         $('#chat-messages').empty(); 
                         history.forEach(log => {
                            const messageData = {
                                type: 'chat',
                                message: log.message, 
                                nickname: log.conversation_name,
                                city: log.conversation_location,
                                pictureUrl: log.pictureUrl || '',
                                timestamp: log.updated_time,
                                userId: log.conversation_id 
                            };
                            appendChatMessage(messageData);
                         });
                         console.log(`已載入 ${history.length} 筆歷史訊息。`);
                         const $chatMessages = $('#chat-messages');
                         $chatMessages.scrollTop($chatMessages[0].scrollHeight);
                    }
                } catch (error) {
                    console.error("無法載入歷史聊天紀錄:", error);
                    showNotification('載入歷史聊天紀錄失敗', 'error');
                }
            }

            function initializeChat() {
                const WEBSOCKET_URL = 'wss://deliverymap.onrender.com/';
                
                function connect() {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        return;
                    }

                    ws = new WebSocket(WEBSOCKET_URL);

                    ws.onopen = function() {
                        console.log('聊天室已連線。');
                        sendJoinMessage();
                        
                        if (heartbeatInterval) clearInterval(heartbeatInterval);
                        heartbeatInterval = setInterval(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({ type: 'ping' }));
                            }
                        }, 30000);
                    };

                    ws.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            
                            switch (data.type) {
                                case 'history':
                                    console.log("正在忽略來自 WebSocket 的記憶體歷史訊息。");
                                    break;
                                case 'chat':
                                    if ($('#chat-modal').hasClass('hidden')) {
                                        unreadChatCount++;
                                        const $badge = $('#chat-unread-badge');
                                        $badge.text(unreadChatCount).removeClass('hidden');
                                    }
                                    appendChatMessage(data);
                                    const $chatWindow = $('#chat-messages');
                                    $chatWindow.scrollTop($chatWindow[0].scrollHeight);
                                    break;
                                case 'system_join':
                                case 'system_leave':
                                case 'system_name_change':
                                    appendChatMessage(data);
                                    break;
                                case 'pong':
                                    break;
                                default:
                                    console.warn("收到未知的訊息類型:", data.type);
                            }
                        } catch (e) {
                            console.error("無法解析收到的訊息:", event.data, e);
                        }
                    };

                    ws.onclose = function() {
                        console.log('聊天室連線已中斷，3秒後嘗試重新連線...');
                        if (heartbeatInterval) clearInterval(heartbeatInterval);
                        setTimeout(connect, 3000);
                    };

                    ws.onerror = function(error) {
                        console.error('WebSocket 錯誤:', error);
                        ws.close();
                    };
                }

                connect();
            }
            
            function sendJoinMessage() {
                if (isLoggedIn && ws && ws.readyState === WebSocket.OPEN) {
                    const payload = {
                        type: 'join',
                        userId: userProfile.email || userProfile.lineUserId, 
                        nickname: currentUserDisplayName,
                        pictureUrl: userProfile.pictureUrl || '',
                        city: currentUserCity
                    };
                    ws.send(JSON.stringify(payload));
                }
            }
            
            function appendChatMessage(data) {
                const $chatMessages = $('#chat-messages');
                
                if ($chatMessages.find(`[data-timestamp="${data.timestamp}"]`).length > 0) {
                    return;
                }
                
                const messageTime = new Date(data.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Taipei' });
                
                const sanitizedMessage = $('<div>').text(data.message || '').html();
                const sanitizedNickname = $('<div>').text(data.nickname || '匿名').html();
                const sanitizedCity = $('<div>').text(data.city || '未知區域').html();
                const sanitizedPictureUrl = data.pictureUrl ? $('<div>').text(data.pictureUrl).html() : 'https://placehold.co/40x40/E2E8F0/A0AEC0?text=?';

                let messageHtml = '';

                switch (data.type) {
                    case 'chat':
                        const nicknameColor = 'text-blue-600';
                        messageHtml = `
                            <div class="chat-message-item flex items-start space-x-3 p-1 rounded-md hover:bg-gray-100" 
                                 data-timestamp="${data.timestamp}" 
                                 data-user-id="${data.userId || ''}" 
                                 data-user-name="${sanitizedNickname}">
                                <img src="${sanitizedPictureUrl}" alt="avatar" class="w-8 h-8 rounded-full flex-shrink-0">
                                <div class="flex-grow">
                                    <div class="flex items-baseline space-x-2">
                                        <span class="font-bold ${nicknameColor}">${sanitizedNickname}</span>
                                        <span class="text-xs text-gray-500">(${sanitizedCity})</span>
                                        <span class="text-xs text-gray-400">${messageTime}</span>
                                    </div>
                                    <p class="text-gray-800 break-words">${sanitizedMessage}</p>
                                </div>
                            </div>
                        `;
                        break;
                    case 'system_join':
                    case 'system_leave':
                    case 'system_name_change':
                        messageHtml = `
                            <div class="text-center text-xs text-gray-500 italic py-1 system-message" data-timestamp="${data.timestamp}">
                                ${sanitizedMessage}
                            </div>
                        `;
                        break;
                }
                
                if(messageHtml) {
                    $chatMessages.append(messageHtml);
                }
            }
            
            function sendChatMessage() {
                if (!isLoggedIn) {
                    showNotification('請先登入才能發言！', 'warning');
                    return;
                }
                
                const $input = $('#chat-input');
                const message = $input.val().trim();

                if (message && ws && ws.readyState === WebSocket.OPEN) {
                    const payload = {
                        type: 'chat',
                        message: message
                    };
                    ws.send(JSON.stringify(payload));
                    $input.val('');
                }
            }


            function showNotification(message, type = 'info') {
                const $notification = $('#notification');
                $notification.text(message).removeClass('hidden');
                $notification.removeClass('bg-blue-500 bg-green-500 bg-red-500 bg-yellow-500');
                switch(type) {
                    case 'error': $notification.addClass('bg-red-500'); break;
                    case 'success': $notification.addClass('bg-green-500'); break;
                    case 'warning': $notification.addClass('bg-yellow-500'); break;
                    default: $notification.addClass('bg-blue-500');
                }
                setTimeout(() => $notification.addClass('hidden'), 5000);
            }
            
            async function loadData(city = null) {
                showNotification('正在讀取資料...');
                let url = `${APPS_SCRIPT_URL}?action=getData&t=${new Date().getTime()}`;
                if (city) {
                    url += `&city=${encodeURIComponent(city)}`;
                }
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    
                    const results = await response.json();
                    rawReports = results;
                    
                    const groupedData = new Map();
                    const communityAreas = [];

                    results.forEach(data => {
                        if (data.isCommunity) {
                            communityAreas.push(data);
                        }

                        const baseAddress = (data['地址'] || '').split(/樓|之|-/)[0].trim();
                        if (baseAddress) {
                            if (!groupedData.has(baseAddress)) {
                                groupedData.set(baseAddress, []);
                            }
                            groupedData.get(baseAddress).push(data);
                        }
                    });

                    vectorSource.clear();
                    areaGridSource.clear();
                    allFeatures = [];
                    const pinyinOptions = { pattern: 'pinyin', toneType: 'none', removeNonZh: true };
                    
                    drawCommunityAreas(communityAreas);

                    groupedData.forEach((group, baseAddress) => {
                        if(group.every(item => item.isCommunity)) return;
                        createPointFeature(group, baseAddress, pinyin, pinyinOptions);
                    });
                    
                    
                    const fuseOptions = {
                        includeScore: true,
                        threshold: 0.1, 
                        minMatchCharLength: 2,
                        ignoreLocation: true,
                        keys: [
                            'values_.address_pinyin',
                            'values_.reports.blacklistReason'
                        ]
                    };
                    fuse = new Fuse(allFeatures, fuseOptions);

                    populateFiltersAndLegend();
                    updateStoreList(); 
                    $('#notification').addClass('hidden');

                } catch (error) {
                    console.error("Load data error:", error);
                    showNotification('無法載入資料！請稍後再試。', 'error');
                }
            }

            function createPointFeature(group, baseAddress, pinyinFn, pinyinOptions) {
                const firstReport = group[0];
                const lon = parseFloat(firstReport['經度']);
                const lat = parseFloat(firstReport['緯度']);

                if (isNaN(lon) || isNaN(lat)) return;

                const totalLikes = group.reduce((sum, report) => sum + (parseInt(report.likes, 10) || 0), 0);
                const totalDislikes = group.reduce((sum, report) => sum + (parseInt(report.dislikes, 10) || 0), 0);

                const feature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
                    name: baseAddress, 
                    category: firstReport['分類'] || '其他', 
                    address: baseAddress,
                    likes: totalLikes,
                    dislikes: totalDislikes,
                    lon: lon, 
                    lat: lat,
                    approved: group.some(r => String(r['審核']).toUpperCase() === 'TRUE'),
                    reports: group, 
                    address_pinyin: pinyinFn(baseAddress || '', pinyinOptions),
                });
                feature.setId(baseAddress);
                
                if (feature.get('approved')) {
                    allFeatures.push(feature);
                    vectorSource.addFeature(feature);
                }
            }

            function populateFiltersAndLegend() {
                const $categorySelect = $('#category-select');
                const $addCategorySelect = $('#add-category');
                const $legendContent = $('#legend-content');
                const $storeListFilters = $('#store-list-filters');
                
                $categorySelect.html('<option value="">所有分類</option>');
                $addCategorySelect.html('');
                $legendContent.html('');
                $storeListFilters.html('<button data-category="" class="store-filter-btn active bg-blue-600 text-white px-2 py-0.5 text-xs rounded-full mr-2 flex-shrink-0">全部</button>');
                
                allCategories.forEach(category => {
                     if (legendIcons[category]) {
                        $categorySelect.append(`<option value="${category}">${category}</option>`);
                        $addCategorySelect.append($('<option>', { value: category, text: category }));
                        const iconSrc = legendIcons[category];
                        $legendContent.append(`<div class="flex items-center"><img src="${iconSrc}" class="h-4 w-4 mr-1.5">${category}</div>`);
                        $storeListFilters.append(`<button data-category="${category}" class="store-filter-btn text-nowrap bg-white text-black px-2 py-0.5 text-xs rounded-full mr-2 flex-shrink-0 border" style="border-color: ${categoryColors[category]};">${category}</button>`);
                     }
                });
            }
            
            function applyFilters() {
                const category = $('#category-select').val();
                const keyword = $('#keyword-search').val();
                
                let results = allFeatures;

                if (keyword && fuse) {
                    const pinyinKeyword = pinyin(keyword, { pattern: 'pinyin', toneType: 'none', removeNonZh: true });
                    const fuseResult = fuse.search(pinyinKeyword);
                    results = fuseResult.map(result => result.item);
                }

                const finalFeatures = results.filter(feature => {
                    if (!feature.get('approved')) return false;
                    if (category && feature.get('category') !== category) return false;
                    return true;
                });
                
                vectorSource.clear();
                vectorSource.addFeatures(finalFeatures);
                updateStoreList(); 
                $('#filter-modal').addClass('hidden');
            }
            
            $('#open-filter-modal').on('click', () => $('#filter-modal').removeClass('hidden'));
            $('#close-filter-modal, #filter-btn').on('click', () => $('#filter-modal').addClass('hidden'));
            $('#filter-btn').on('click', applyFilters);
            $('#reset-btn').on('click', () => {
                $('#category-select, #keyword-search').val('');
                const approvedFeatures = allFeatures.filter(f => f.get('approved'));
                vectorSource.clear();
                vectorSource.addFeatures(approvedFeatures);
                updateStoreList(); 
            });
            $('#close-product-modal').on('click', () => $('#product-modal').addClass('hidden'));

            $('#center-on-me-btn').on('click', () => {
                if (userPositionCoords) map.getView().animate({ center: userPositionCoords, zoom: 16, duration: 800 });
                else showNotification('無法定位您的位置。', 'warning');
            });
            
            async function performSearch(address) {
                if (!address || address.trim() === '') return;

                showNotification('正在搜尋地址...', 'info');
                const data = await geocodeAddress(address);
                const $notification = $('#notification');
                
                if (data && data.results && data.results.length > 0) {
                    if ($notification.text() === '正在搜尋地址...') {
                        $notification.addClass('hidden');
                    }
                    const location = data.results[0].geometry.location;
                    const coords = ol.proj.fromLonLat([location.lng, location.lat]);
                    map.getView().animate({ center: coords, zoom: 17, duration: 800 });
                    $('#search-panel').addClass('hidden');
                } else {
                    showNotification('找不到您輸入的地址', 'error');
                }
            }

            $('#search-address-btn').on('click', async function() {
                const $searchPanel = $('#search-panel');
                
                if ($searchPanel.hasClass('hidden')) { 
                    $searchPanel.removeClass('hidden');
                    $('#search-address-input').val('').focus();

                    try {
                        const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                        if (permission.state === 'granted' || permission.state === 'prompt') {
                            const text = await navigator.clipboard.readText();
                            if (text && text.trim()) {
                                const addressKeywords = ['區', '路', '街', '巷', '弄', '號'];
                                const isAddress = addressKeywords.some(keyword => text.includes(keyword));
                                if (isAddress) {
                                    $('#search-address-input').val(text);
                                    performSearch(text);
                                }
                            }
                        }
                    } catch (err) {
                        console.warn('無法讀取剪貼簿，可能是權限問題或瀏覽器不支援。');
                    }
                } else {
                    $searchPanel.addClass('hidden');
                }
            });

            $('#close-search-panel').on('click', () => {
                $('#search-panel').addClass('hidden');
            });

            $('#search-address-input').on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch($(this).val());
                }
            });

            function drawGrid() {
                if (!isAreaSelectionMode) return;
                
                const mapSize = map.getSize();
                gridCanvas.width = mapSize[0];
                gridCanvas.height = mapSize[1];
                gridCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                
                $('#grid-toolbar').removeClass('hidden').addClass('flex');

                const extent = map.getView().calculateExtent(mapSize);
                const [minLon, minLat] = ol.proj.toLonLat(ol.extent.getBottomLeft(extent));
                const [maxLon, maxLat] = ol.proj.toLonLat(ol.extent.getTopRight(extent));
                
                const startLon = Math.floor(minLon / GRID_INTERVAL) * GRID_INTERVAL;
                const startLat = Math.floor(minLat / GRID_INTERVAL) * GRID_INTERVAL;
                
                gridCtx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                gridCtx.lineWidth = 1;
                gridCtx.beginPath();
                for (let lon = startLon; lon < maxLon; lon += GRID_INTERVAL) {
                    const pixel = map.getPixelFromCoordinate(ol.proj.fromLonLat([lon, minLat]));
                    if(pixel) {
                        gridCtx.moveTo(pixel[0], 0);
                        gridCtx.lineTo(pixel[0], mapSize[1]);
                    }
                }
                for (let lat = startLat; lat < maxLat; lat += GRID_INTERVAL) {
                    const pixel = map.getPixelFromCoordinate(ol.proj.fromLonLat([minLon, lat]));
                    if(pixel) {
                        gridCtx.moveTo(0, pixel[1]);
                        gridCtx.lineTo(mapSize[0], pixel[1]);
                    }
                }
                gridCtx.stroke();

                gridCtx.font = 'bold 16px sans-serif';
                gridCtx.textAlign = 'center';
                gridCtx.textBaseline = 'middle';
                
                selectedGridCells.forEach((data, cellKey) => {
                    const [lon, lat] = cellKey.split('-').map(Number);

                    const bottomLeft = ol.proj.fromLonLat([lon, lat]);
                    const topRight = ol.proj.fromLonLat([lon + GRID_INTERVAL, lat + GRID_INTERVAL]);
                    
                    const p1 = map.getPixelFromCoordinate(bottomLeft);
                    const p2 = map.getPixelFromCoordinate(topRight);
                    
                    if (!p1 || !p2) return;

                    const width = Math.abs(p2[0] - p1[0]);
                    const height = Math.abs(p1[1] - p2[1]);
                    
                    if (data.fillColor) {
                        gridCtx.fillStyle = data.fillColor;
                        gridCtx.fillRect(p1[0], p2[1], width, height);
                    }
                    
                    if (data.marker) {
                        gridCtx.fillStyle = data.markerColor || '#000000';
                        const markerText = {
                            'entrance': '入',
                            'exit': '出',
                            'table': '桌',
                            'parking': '停'
                        }[data.marker];
                        gridCtx.fillText(markerText, p1[0] + width / 2, p2[1] + height / 2);
                    }
                });

                // --- MODIFICATION: Draw red dot for locked center ---
                if (lockedCenterForEditing) {
                    const pixel = map.getPixelFromCoordinate(lockedCenterForEditing);
                    if (pixel) {
                        gridCtx.beginPath();
                        gridCtx.arc(pixel[0], pixel[1], 8, 0, 2 * Math.PI, false);
                        gridCtx.fillStyle = 'rgba(239, 68, 68, 0.9)'; // red-500
                        gridCtx.fill();
                        gridCtx.lineWidth = 2;
                        gridCtx.strokeStyle = 'white';
                        gridCtx.stroke();
                    }
                }
            }

            function paintCell(evt) {
                if (currentAreaTool === 'pan') return;

                const pixel = evt.pixel;
                const coord = map.getCoordinateFromPixel(pixel);
                if (!coord) return;
                const [lon, lat] = ol.proj.toLonLat(coord);
                
                const snappedLon = Math.floor(lon / GRID_INTERVAL) * GRID_INTERVAL;
                const snappedLat = Math.floor(lat / GRID_INTERVAL) * GRID_INTERVAL;
                
                const cellKey = `${snappedLon.toFixed(GRID_PRECISION)}-${snappedLat.toFixed(GRID_PRECISION)}`;
                
                if (cellKey === lastPaintedCellKey) return;
                lastPaintedCellKey = cellKey;

                const centerCoords = lockedCenterForEditing || (tempMarker ? tempMarker.getPosition() : map.getView().getCenter());
                const centerLonLat = ol.proj.toLonLat(centerCoords);
                if (ol.sphere.getDistance(centerLonLat, [snappedLon, snappedLat]) > GRID_DRAW_RADIUS) return;

                const existingData = selectedGridCells.get(cellKey);

                if (currentAreaTool === 'fill') {
                    if (existingData && existingData.fillColor) {
                        delete existingData.fillColor;
                        if (!existingData.marker) {
                            selectedGridCells.delete(cellKey);
                        }
                    } else {
                        const newData = existingData || {};
                        newData.fillColor = currentAreaColor;
                        selectedGridCells.set(cellKey, newData);
                    }
                } else if (currentAreaTool === 'eraser') {
                    selectedGridCells.delete(cellKey);
                } else { // Marker tools
                    const newData = existingData || {};
                    newData.marker = newData.marker === currentAreaTool ? null : currentAreaTool;
                    if (newData.marker) {
                        newData.markerColor = currentMarkerColor;
                    }
                    
                    if (!newData.fillColor && !newData.marker) {
                        selectedGridCells.delete(cellKey);
                    } else {
                        selectedGridCells.set(cellKey, newData);
                    }
                }
                drawGrid();
            }

            const mapPointerDown = function(evt) {
                if (evt.originalEvent.button !== 0) return;
                
                if (!isAreaSelectionMode || currentAreaTool === 'pan') return;
                isDrawingOnGrid = true;
                paintCell(evt);
                map.on('pointermove', mapPointerMove);
                map.getViewport().addEventListener('pointerup', mapPointerUp, { once: true });
            };

            const mapPointerMove = function(evt) {
                if (!isDrawingOnGrid) return;
                paintCell(evt);
            };

            const mapPointerUp = function() {
                isDrawingOnGrid = false;
                lastPaintedCellKey = null;
                map.un('pointermove', mapPointerMove);
            };
            
            function toggleAreaSelectionMode(enable, areaBoundsToLoad = null) {
                isAreaSelectionMode = enable;
                
                map.un('moveend', drawGrid);
                $('#grid-color-palette').toggleClass('hidden', !enable);
                // --- MODIFICATION: Show/hide mobile submit button ---
                $('#mobile-grid-submit-btn').toggleClass('hidden', !enable);

                if (enable) {
                    const zoomThreshold = isMobile ? GRID_ZOOM_LEVEL_MOBILE : GRID_ZOOM_LEVEL_WEB;
                    map.getView().animate({ zoom: zoomThreshold, duration: 800 });
                    $('#map').addClass('map-enhanced grid-mode-active paint-mode');
                    
                    if (dragPanInteraction) dragPanInteraction.setActive(false);
                    
                    $('#location-instruction').text('請在地圖上的網格標示範圍。');
                    
                    $('#desktop-center-marker').addClass('hidden');
                    if (tempMarker) {
                        tempMarker.getElement().style.display = 'none';
                    }
                    
                    if (isMobile) {
                        const $buttons = $('#main-action-buttons');
                        if ($buttons.length) {
                            cachedActionButtons = $buttons.detach();
                        }
                        $('#add-location-modal-mobile').addClass('minimized');
                        $('#restore-mobile-modal-btn').removeClass('hidden');
                    }
                    
                    selectedGridCells.clear();
                    if (areaBoundsToLoad) {
                        try {
                            const areaBoundsData = JSON.parse(areaBoundsToLoad);
                            let cellsToLoad;
                            
                            if (areaBoundsData.v === 1) {
                                const { o: originCoords, p: palette, c: compressedCells } = areaBoundsData;
                                const origin = { lon: parseFloat(originCoords[0]), lat: parseFloat(originCoords[1]) };
                                const markerReverseMap = { 'e': 'entrance', 'x': 'exit', 't': 'table', 'p': 'parking' };

                                cellsToLoad = compressedCells.map(cellString => {
                                    const parts = cellString.split(':');
                                    const [x, y] = parts[0].split(',').map(Number);
                                    const [fillIndex, markerChar, markerColorIndex] = parts.slice(1);
                                    
                                    const lon = origin.lon + x * GRID_INTERVAL;
                                    const lat = origin.lat + y * GRID_INTERVAL;
                                    
                                    const data = {};
                                    if (fillIndex !== '') data.fillColor = palette.f[parseInt(fillIndex, 10)];
                                    if (markerChar !== '') data.marker = markerReverseMap[markerChar];
                                    if (markerColorIndex !== '') data.markerColor = palette.m[parseInt(markerColorIndex, 10)];
                                    
                                    return { key: `${lon.toFixed(GRID_PRECISION)}-${lat.toFixed(GRID_PRECISION)}`, data };
                                });
                            } else {
                                cellsToLoad = areaBoundsData.map(cell => {
                                    const { lon, lat, ...data } = cell;
                                    return { key: `${lon.toFixed(GRID_PRECISION)}-${lat.toFixed(GRID_PRECISION)}`, data };
                                });
                            }
                            
                            cellsToLoad.forEach(item => selectedGridCells.set(item.key, item.data));
                            
                        } catch (e) {
                            console.error("Failed to load area bounds for editing:", e);
                            showNotification('讀取建築範圍資料失敗！', 'error');
                        }
                    }
                    
                    $('#grid-canvas').removeClass('hidden');
                    drawGrid();
                    map.on('moveend', drawGrid);
                    map.on('pointerdown', mapPointerDown);
                } else {
                    $('#map').removeClass('map-enhanced grid-mode-active paint-mode pan-mode');
                    if (dragPanInteraction) dragPanInteraction.setActive(true);
                    if (isMobile && tempMarker) {
                         tempMarker.getElement().style.pointerEvents = 'auto';
                         tempMarker.getElement().style.display = 'block';
                    }
                    if (isMobile) {
                        if (cachedActionButtons) {
                            $('#map-container').append(cachedActionButtons);
                            cachedActionButtons = null;
                        }
                        $('#add-location-modal-mobile').removeClass('minimized');
                        $('#restore-mobile-modal-btn').addClass('hidden');
                    }
                    if (!isMobile) {
                        $('#desktop-center-marker').removeClass('hidden');
                    }
                    $('#location-instruction').text('請移動地圖中心點來選擇位置。');
                    $('#grid-canvas').addClass('hidden');
                    $('#grid-toolbar').addClass('hidden').removeClass('flex');
                    gridCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                    map.un('pointerdown', mapPointerDown);
                }
            }

            // Manually minimize the mobile modal
            $('#minimize-mobile-modal-btn').on('click', function() {
                $('#add-location-modal-mobile').addClass('minimized');
                $('#restore-mobile-modal-btn').removeClass('hidden');
            });

            // Restore the minimized mobile modal
            $('#restore-mobile-modal-btn').on('click', function() {
                $('#add-location-modal-mobile').removeClass('minimized');
                $(this).addClass('hidden');
            });

            function setupGridToolbar() {
                const $fillToolSvg = $('#tool-fill svg');
                const $markerToolBtns = $('#marker-tools .grid-tool-btn');

                $('#palette-fill-color').on('input', function() {
                    const hexColor = $(this).val();
                    const r = parseInt(hexColor.slice(1, 3), 16);
                    const g = parseInt(hexColor.slice(3, 5), 16);
                    const b = parseInt(hexColor.slice(5, 7), 16);
                    currentAreaColor = `rgba(${r}, ${g}, ${b}, 0.7)`;
                    $fillToolSvg.css('stroke', hexColor);
                });

                $('#palette-marker-color').on('input', function() {
                    currentMarkerColor = $(this).val();
                    $markerToolBtns.css('color', currentMarkerColor);
                });

                $fillToolSvg.css('stroke', $('#palette-fill-color').val());
                $markerToolBtns.css('color', $('#palette-marker-color').val());

                $('.grid-tool-btn').on('click', function() {
                    const $clickedBtn = $(this);
                    const toolId = $clickedBtn.attr('id');
                    
                    if ($clickedBtn.hasClass('active')) {
                        if (toolId === 'tool-fill') {
                            $('#palette-fill-color').trigger('click');
                        } else if ($clickedBtn.closest('#marker-tools').length) {
                            $('#palette-marker-color').trigger('click');
                        }
                        return;
                    }
                    
                    $('.grid-tool-btn').removeClass('active');
                    $clickedBtn.addClass('active');
                    currentAreaTool = toolId.replace('tool-', '');

                    if (currentAreaTool === 'pan') {
                        if (dragPanInteraction) dragPanInteraction.setActive(true);
                        $('#map').removeClass('paint-mode').addClass('pan-mode');
                    } else {
                        if (dragPanInteraction) dragPanInteraction.setActive(false);
                        $('#map').removeClass('pan-mode').addClass('paint-mode');
                    }
                });
            }
            
            $(document).on('change', '#add-is-area', function() {
                const isChecked = $(this).is(':checked');
                const isAreaEdit = !!($('#edit-area-row-index').val());

                if (isChecked) {
                    if (isAreaEdit) {
                        lockedCenterForEditing = isMobile ? tempMarker.getPosition() : map.getView().getCenter();
                    }
                    toggleAreaSelectionMode(true, isAreaEdit ? areaBoundsForEditing : null);
                } else {
                    lockedCenterForEditing = null;
                    toggleAreaSelectionMode(false);
                }
            });
            
            $('#add-location-modal-mobile').on('click', '.mobile-add-tab', function() {
                const $clickedTab = $(this);
                const isAreaTab = $clickedTab.attr('id') === 'mobile-add-area-tab';
                const $form = $('#add-location-form-mobile');

                $('.mobile-add-tab').removeClass('active text-indigo-600 bg-indigo-50 rounded-t-lg').addClass('text-gray-500 hover:text-gray-700');
                $clickedTab.addClass('active text-indigo-600 bg-indigo-50 rounded-t-lg').removeClass('text-gray-500 hover:text-gray-700');

                $('#mobile-point-fields').toggleClass('hidden', isAreaTab);
                $('#mobile-area-fields').toggleClass('hidden', !isAreaTab);
                $('#minimize-mobile-modal-btn').toggleClass('hidden', !isAreaTab);
                
                // --- BEGIN MODIFICATION: Set locked center on tab switch ---
                if (isAreaTab && tempMarker) {
                    lockedCenterForEditing = tempMarker.getPosition();
                } else {
                    lockedCenterForEditing = null;
                }
                // --- END MODIFICATION ---

                const $isAreaCheckbox = $form.find('#add-is-area');
                if ($isAreaCheckbox.length) {
                    if ($isAreaCheckbox.is(':checked') !== isAreaTab) {
                        $isAreaCheckbox.prop('checked', isAreaTab).trigger('change');
                    }
                }
            });

            function drawRadiusCircle(centerCoords) {
                radiusSource.clear();
                const view = map.getView();
                const projection = view.getProjection();
                const resolution = view.getResolution();
                const radius = 500; 
                
                const circle = new ol.geom.Circle(centerCoords, radius / ol.proj.getPointResolution(projection, resolution, centerCoords));
                const circleFeature = new ol.Feature(circle);
                radiusSource.addFeature(circleFeature);
            }

            // --- BEGIN MODIFICATION: Updated pointer move handler for dragging marker ---
            function handlePointerMove(e) {
                if (isDraggingMarker) {
                    const newCoord = map.getEventCoordinate(e);
                    tempMarker.setPosition(newCoord);
                }
            }
            // --- END MODIFICATION ---
            
            // --- BEGIN MODIFICATION: Updated pointer up handler with reverse geocoding ---
            function handlePointerUp() {
                if (isDraggingMarker) {
                    isDraggingMarker = false;
                    map.getInteractions().forEach(i => { if(i instanceof ol.interaction.DragPan) i.setActive(true); });
                    document.removeEventListener('pointermove', handlePointerMove);
                    document.removeEventListener('pointerup', handlePointerUp);

                    // Reverse geocode after drag ends
                    const finalCoords = tempMarker.getPosition();
                    const finalLonLat = ol.proj.toLonLat(finalCoords);
                    reverseGeocode(finalLonLat[0], finalLonLat[1], $('#add-location-form-mobile'));
                }
            }
            // --- END MODIFICATION ---
            
            function enterMobilePlacementMode(coordinate, areaBoundsToLoad = null) {
                initialAddLocationCoords = coordinate;
                if(tempMarker) map.removeOverlay(tempMarker);

                const markerEl = document.createElement('div');
                markerEl.className = 'new-location-marker';
                
                tempMarker = new ol.Overlay({
                    element: markerEl, position: coordinate, positioning: 'bottom-center', stopEvent: false,
                });
                map.addOverlay(tempMarker);

                if (areaBoundsToLoad) {
                    $('#add-is-area').prop('checked', false);
                    toggleAreaSelectionMode(false); 
                    $('#add-location-modal-mobile').removeClass('hidden'); 
                } else {
                    drawRadiusCircle(coordinate);
                    $('#complete-placement-btn').removeClass('hidden');
                    map.getView().animate({ center: coordinate, zoom: 18, duration: 500 });
                }

                // --- BEGIN MODIFICATION: Simplified drag listener for mobile marker ---
                markerEl.addEventListener('pointerdown', (e) => {
                    const isAreaModeActive = $('#mobile-add-area-tab').hasClass('active');
                    if (isAreaModeActive) return; // Don't allow dragging in area mode from marker

                    isDraggingMarker = true;
                    map.getInteractions().forEach(i => { if(i instanceof ol.interaction.DragPan) i.setActive(false); });
                    document.addEventListener('pointermove', handlePointerMove);
                    document.addEventListener('pointerup', handlePointerUp);
                    e.stopPropagation();
                });
                // --- END MODIFICATION ---
            }

            function enterDesktopAddMode(coordinate, areaBoundsToLoad = null) {
                initialAddLocationCoords = coordinate;
                $('#app-container').addClass('desktop-add-mode');
                
                $('#desktop-center-marker').removeClass('hidden');

                if (areaBoundsToLoad) {
                     $('#add-is-area').prop('checked', false);
                    toggleAreaSelectionMode(false);
                }
                
                setTimeout(() => {
                    map.updateSize();
                    if (!areaBoundsToLoad) {
                        drawRadiusCircle(coordinate);
                    }
                    map.getView().animate({ center: coordinate, zoom: 17, duration: 500 }, () => {
                        const centerCoords = map.getView().getCenter();
                        const centerLonLat = ol.proj.toLonLat(centerCoords);
                        reverseGeocode(centerLonLat[0], centerLonLat[1]);
                    });
                }, 350);

                map.on('moveend', handleDesktopMapMove);
            }
            
            function handleDesktopMapMove() {
                const isAreaEdit = !!($('#edit-area-row-index').val());
                if ($('#app-container').hasClass('desktop-add-mode')) {
                     if (isAreaEdit && $('#add-is-area').is(':checked')) {
                        return; 
                     }
                    const centerCoords = map.getView().getCenter();
                    const centerLonLat = ol.proj.toLonLat(centerCoords);
                    reverseGeocode(centerLonLat[0], centerLonLat[1]);
                }
            }
            
            function exitAddMode() {
                if (isAreaSelectionMode) {
                    toggleAreaSelectionMode(false);
                }
                
                radiusSource.clear();
                initialAddLocationCoords = null;
                lockedCenterForEditing = null;
                
                if (isMobile) {
                    if(tempMarker) map.removeOverlay(tempMarker);
                    tempMarker = null;
                    $('#complete-placement-btn').addClass('hidden');
                    $('#add-location-modal-mobile').addClass('hidden').removeClass('minimized');
                    $('#restore-mobile-modal-btn').addClass('hidden');
                } else {
                    $('#app-container').removeClass('desktop-add-mode');
                    $('#desktop-center-marker').addClass('hidden');
                    map.un('moveend', handleDesktopMapMove);
                    setTimeout(() => map.updateSize(), 350);
                }
                $('#add-is-area').prop('checked', false);
                $('#edit-row-index, #edit-area-row-index, #edit-original-name').val('');
                loadData();
            }

            $('#add-location-btn').on('click', function() {
                if (!isLoggedIn) {
                    showNotification('請先登入才能新增地點！', 'warning');
                    return;
                }
                
                const forms = [$('#add-location-form'), $('#add-location-form-mobile')];
                forms.forEach($f => {
                    const $blCat = $f.find('#add-blacklist-category');
                    const $blReason = $f.find('#add-blacklist-reason');
                    $blCat.prop('required', false);
                    $blReason.prop('required', false);
                    $blCat.prev('label').html('黑名類別');
                    $blReason.prev('label').html('黑名原因');
                });


                showNotification('正在取得您的目前位置...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = [position.coords.longitude, position.coords.latitude];
                        const mapCoords = ol.proj.fromLonLat(coords);
                        
                        if (isMobile) {
                            enterMobilePlacementMode(mapCoords);
                        } else {
                            enterDesktopAddMode(mapCoords);
                        }
                    },
                    (error) => {
                        showNotification('無法取得您的位置，請手動輸入地址。', 'warning');
                        if (isMobile) {
                            enterMobilePlacementMode(map.getView().getCenter());
                        } else {
                            enterDesktopAddMode(map.getView().getCenter());
                        }
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            });
            
            $('#complete-placement-btn').on('click', function() {
                const finalCoords = tempMarker.getPosition();
                const finalLonLat = ol.proj.toLonLat(finalCoords);
                
                // --- BEGIN MODIFICATION: Update form cloning logic for Area Name ---
                const formContent = $('#add-location-form > .px-6').children().clone(true, true);
                const $pointFields = $('#mobile-point-fields');
                const $areaFields = $('#mobile-area-fields');
                
                $pointFields.empty().append(formContent);
                $areaFields.empty().append($pointFields.children().clone(true, true));
                
                // Hide fields not relevant to areas and show the ones that are
                $areaFields.find('#add-category, #add-blacklist-category, #add-blacklist-reason').closest('div').hide();
                $areaFields.find('#add-area-name').closest('div').show();

                // Hide area name for points
                $pointFields.find('#add-area-name').closest('div').hide();
                $pointFields.find('#add-category, #add-blacklist-category, #add-blacklist-reason').closest('div').show();
                // --- END MODIFICATION ---

                $('#add-location-form-mobile')[0].reset();
                reverseGeocode(finalLonLat[0], finalLonLat[1], $('#add-location-form-mobile'));
                
                $('#minimize-mobile-modal-btn').addClass('hidden');
                
                $('#mobile-add-point-tab').trigger('click');

                $('#add-location-modal-mobile').removeClass('hidden');
                $('#complete-placement-btn').addClass('hidden');
            });

            // --- BEGIN MODIFICATION: Add click listener for new mobile submit button ---
            $('#mobile-grid-submit-btn').on('click', function() {
                $('#add-location-form-mobile').submit();
            });
            // --- END MODIFICATION ---

            $('#close-add-location-modal, #close-add-location-modal-mobile').on('click', exitAddMode);

            function extractAddressNumbers(address) {
                if (!address) return [Infinity];
                address = address.replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0) - 65248))
                                 .replace(/地下/g, 'B')
                                 .replace(/之/g, '.');
                const numbers = address.match(/B?\d+(\.\d+)?/g);
                if (!numbers) return [Infinity];
                return numbers.map(n => n.startsWith('B') ? -parseFloat(n.substring(1)) : parseFloat(n));
            }

            function compareAddresses(a, b) {
                const numsA = extractAddressNumbers(a);
                const numsB = extractAddressNumbers(b);
                const minLength = Math.min(numsA.length, numsB.length);
                for (let i = 0; i < minLength; i++) {
                    if (numsA[i] !== numsB[i]) return numsA[i] - numsB[i];
                }
                return numsA.length - numsB.length;
            }

            function renderConsolidatedPopup(featureData, reports) {
                const shortAddress = formatAddress(reports[0]['地址']);
                let reportsHtml = reports.map(report => {
                    const reportDate = report.timestamp || report.Timestamp;
                    const dateString = reportDate ? new Date(reportDate).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }) : '日期不明';
                    return `
                        <div class="border-t pt-2 mt-2">
                            <p class="text-xs text-gray-500">${report.submitterName || '匿名'} &bull; ${dateString}</p>
                            <p class="font-semibold">${report['黑名類別']}</p>
                            <p class="whitespace-pre-wrap">${report['黑名原因'] || ''}</p>
                        </div>
                    `;
                }).join('');

                popupContent.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800">${shortAddress}</h3>
                    ${renderVoteSection(featureData)}
                    <div class="text-sm mt-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">
                        ${reportsHtml}
                    </div>
                `;
            }

            function renderUnitListPopup(featureData, reportsByFullAddress) {
                const shortAddress = formatAddress(featureData.address);
                const sortedAddresses = Array.from(reportsByFullAddress.keys()).sort(compareAddresses);

                let listHtml = sortedAddresses.map(fullAddr => {
                    const addrMatch = fullAddr.match(/(\d.*)/);
                    const displayAddr = addrMatch ? addrMatch[1].trim() : fullAddr;
                    return `
                        <li class="border-t py-2 px-1 cursor-pointer hover:bg-gray-100 rounded unit-item" data-address="${encodeURIComponent(fullAddr)}">
                            <p class="font-semibold truncate" title="${fullAddr}">${displayAddr}</p>
                        </li>
                    `;
                }).join('');

                popupContent.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800">${shortAddress}</h3>
                    ${renderVoteSection(featureData)}
                    <p class="text-sm text-gray-600 my-2 border-t pt-2">此地點有多筆回報，請選擇查看：</p>
                    <ul class="text-sm max-h-40 overflow-y-auto custom-scrollbar pr-2">${listHtml}</ul>
                `;
            }

            function renderVoteSection(featureData) {
                const likes = featureData.likes || 0;
                const dislikes = featureData.dislikes || 0;
                const score = likes - dislikes;
                let scoreColor = 'text-gray-600';
                if (score > 0) scoreColor = 'text-green-600';
                if (score < 0) scoreColor = 'text-red-600';

                const locationId = featureData.address;
                const userVote = userVotes[locationId];
                const likeClass = userVote === 'like' ? 'voted-like' : '';
                const dislikeClass = userVote === 'dislike' ? 'voted-dislike' : '';

                return `
                    <div class="flex items-center justify-between text-sm mt-2">
                        <span>總評分 (<span class="score-display ${scoreColor} font-bold">${score}</span>)</span>
                        <div class="flex items-center space-x-2">
                            <button class="vote-btn p-1 rounded-full hover:bg-gray-200 ${likeClass}" data-location-id="${locationId}" data-vote-type="like">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333V17a1 1 0 001 1h6.364a1 1 0 00.949-.684l2.121-6.364A1 1 0 0015.364 9H12V4a1 1 0 00-1-1h-1a1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.4 10.333zM6 8h2.545M5 10.5a1.5 1.5 0 01-1.5-1.5V6a1.5 1.5 0 013 0v3a1.5 1.5 0 01-1.5 1.5z"/></svg>
                            </button>
                             <span class="likes-count text-sm text-gray-600">${likes}</span>
                            <button class="vote-btn p-1 rounded-full hover:bg-gray-200 ${dislikeClass}" data-location-id="${locationId}" data-vote-type="dislike">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667V3a1 1 0 00-1-1h-6.364a1 1 0 00-.949.684L3.565 9H6v7a1 1 0 001 1h1a1 1 0 001-1v-.667a4 4 0 01.8-2.4l1.6-4.8zM14 12h-2.545M15 9.5a1.5 1.5 0 011.5 1.5v3a1.5 1.5 0 01-3 0v-3a1.5 1.5 0 011.5 1.5z"/></svg>
                            </button>
                             <span class="dislikes-count text-sm text-gray-600">${dislikes}</span>
                        </div>
                    </div>
                `;
            }

            $('#popup').on('click', function(e) {
                const $target = $(e.target);
                
                const $unitItem = $target.closest('.unit-item');
                if ($unitItem.length) {
                    const fullAddress = decodeURIComponent($unitItem.data('address'));
                    const reportsForUnit = currentFeatureData.reports.filter(r => r['地址'] === fullAddress);
                    renderConsolidatedPopup(currentFeatureData, reportsForUnit);
                    return;
                }

                const $clusterItem = $target.closest('.cluster-item');
                if ($clusterItem.length) {
                    const address = decodeURIComponent($clusterItem.data('address'));
                    const targetFeature = allFeatures.find(f => f.getId() === address);
                    if (targetFeature) {
                        const data = targetFeature.getProperties();
                        currentFeatureData = data;
                        
                        const reportsByFullAddress = new Map();
                        data.reports.forEach(report => {
                            const fullAddr = report['地址'];
                            if (!reportsByFullAddress.has(fullAddr)) {
                                reportsByFullAddress.set(fullAddr, []);
                            }
                            reportsByFullAddress.get(fullAddr).push(report);
                        });

                        if (reportsByFullAddress.size > 1) {
                            renderUnitListPopup(data, reportsByFullAddress);
                        } else {
                            renderConsolidatedPopup(data, data.reports);
                        }
                    }
                    return;
                }

                const $voteBtn = $target.closest('.vote-btn');
                if ($voteBtn.length) {
                    if (!isLoggedIn) {
                        showNotification('請先登入才能評分！', 'warning');
                        return;
                    }
                    
                    const locationId = $voteBtn.data('location-id');
                    const voteType = $voteBtn.data('vote-type');
                    const previousVote = userVotes[locationId];

                    let likeChange = 0;
                    let dislikeChange = 0;

                    if (previousVote === voteType) { 
                        userVotes[locationId] = null;
                        voteType === 'like' ? likeChange = -1 : dislikeChange = -1;
                    } else if (previousVote) { 
                        userVotes[locationId] = voteType;
                        if (voteType === 'like') {
                            likeChange = 1;
                            dislikeChange = -1;
                        } else {
                            likeChange = -1;
                            dislikeChange = 1;
                        }
                    } else { 
                        userVotes[locationId] = voteType;
                        voteType === 'like' ? likeChange = 1 : dislikeChange = 1;
                    }
                    
                    saveUserVotes();
                    
                    const $popup = $voteBtn.closest('.ol-popup');
                    const currentLikes = parseInt($popup.find('.likes-count').text());
                    const currentDislikes = parseInt($popup.find('.dislikes-count').text());
                    const newLikes = currentLikes + likeChange;
                    const newDislikes = currentDislikes + dislikeChange;
                    
                    $popup.find('.likes-count').text(newLikes);
                    $popup.find('.dislikes-count').text(newDislikes);
                    $popup.find('.score-display').text(newLikes - newDislikes);
                    
                    $popup.find('.vote-btn').removeClass('voted-like voted-dislike');
                    if(userVotes[locationId] === 'like') $popup.find('.vote-btn[data-vote-type="like"]').addClass('voted-like');
                    if(userVotes[locationId] === 'dislike') $popup.find('.vote-btn[data-vote-type="dislike"]').addClass('voted-dislike');

                    if(likeChange !== 0) sendVote(locationId, 'like', likeChange);
                    if(dislikeChange !== 0) sendVote(locationId, 'dislike', dislikeChange);
                }
            });

            function sendVote(locationId, voteType, change) {
                const feature = allFeatures.find(f => f.getId() === locationId);
                if (!feature) return;

                feature.get('reports').forEach(report => {
                    const payload = {
                        action: 'vote',
                        rowIndex: report.rowIndex,
                        voteType: voteType,
                        change: change
                    };
                    fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .catch(error => console.error('Vote submission failed:', error));
                });
            }

            map.on('singleclick', function (evt) {
                if ($('#app-container').hasClass('desktop-add-mode') || isDrawingOnGrid) return;
                
                let featureClicked = false;
                
                const areaFeature = map.forEachFeatureAtPixel(evt.pixel, f => f.get('parentData') ? f : null, {
                    layerFilter: layer => layer === areaGridLayer
                });
                
                if(areaFeature) {
                    featureClicked = true;
                    console.log("Clicked on area:", areaFeature);
                }

                if (featureClicked) return;

                const clusterFeature = map.forEachFeatureAtPixel(evt.pixel, f => f, {
                    layerFilter: layer => layer === clusterLayer
                });

                if (clusterFeature) {
                    featureClicked = true;
                    const featuresInCluster = clusterFeature.get('features');
                    if (featuresInCluster.length > 1) { 
                        const extent = ol.extent.createEmpty();
                        featuresInCluster.forEach(f => ol.extent.extend(extent, f.getGeometry().getExtent()));
                        map.getView().fit(extent, { duration: 500, padding: [80, 80, 80, 80] });
                    } else { 
                        const originalFeature = featuresInCluster[0];
                        const coordinates = originalFeature.getGeometry().getCoordinates();
                        currentFeatureData = originalFeature.getProperties();
                        
                        const reportsByFullAddress = new Map();
                        currentFeatureData.reports.forEach(report => {
                            const fullAddr = report['地址'];
                            if (!reportsByFullAddress.has(fullAddr)) {
                                reportsByFullAddress.set(fullAddr, []);
                            }
                            reportsByFullAddress.get(fullAddr).push(report);
                        });
                        
                        map.getView().animate({ center: coordinates, zoom: 18, duration: 800 });

                        if (reportsByFullAddress.size > 1) {
                            renderUnitListPopup(currentFeatureData, reportsByFullAddress);
                        } else {
                            renderConsolidatedPopup(currentFeatureData, currentFeatureData.reports);
                        }
                        infoOverlay.setPosition(coordinates);
                    }
                }

                if (!featureClicked) {
                    infoOverlay.setPosition(undefined);
                }
            });
            
            async function geocodeAddress(address) {
                const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                try {
                    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}&region=TW&language=zh-TW`);
                    if (!response.ok) throw new Error('Geocoding API response not OK');
                    return await response.json();
                } catch (error) {
                    console.error('Geocoding failed:', error);
                    showNotification('地址解析失敗', 'error');
                    return null;
                }
            }

            async function reverseGeocode(lon, lat, $form = $('#add-location-form')) {
                const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                const $addressInput = $form.find('#add-address');
                const $areaNameInput = $form.find('#add-area-name');
                try {
                    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}&language=zh-TW`);
                    if (!response.ok) throw new Error('Geocoding API response not OK');
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        const results = data.results;
                        $addressInput.val(results[0].formatted_address);
                        latestGeocodeBounds = results[0].geometry.viewport;

                        const poi = results.find(r => 
                            r.types.includes('establishment') || 
                            r.types.includes('point_of_interest') || 
                            r.types.includes('premise')
                        );
                        
                        let foundName = '';
                        if (poi) {
                             const nameComponent = poi.address_components.find(c => c.types.includes('point_of_interest') || c.types.includes('premise'));
                             if(nameComponent) {
                                foundName = nameComponent.long_name;
                             }
                        }
                        
                        if (!foundName) {
                            const sublocality = results[0].address_components.find(c => c.types.includes('administrative_area_level_4') || c.types.includes('sublocality_level_1'));
                            if (sublocality) {
                                foundName = sublocality.long_name;
                            }
                        }
                        
                        if (foundName) {
                            $areaNameInput.val(foundName);
                        } else {
                            $areaNameInput.val('');
                        }

                    } else {
                        $addressInput.val('無法自動定位地址');
                        $areaNameInput.val('');
                        latestGeocodeBounds = null;
                    }
                } catch (error) {
                    $addressInput.val('無法自動定位地址');
                    $areaNameInput.val('');
                    latestGeocodeBounds = null;
                    showNotification('無法解析地址，請手動輸入。', 'warning');
                }
            }
            
            async function getAddressFromCoords(lon, lat) {
                const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                try {
                    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}&language=zh-TW`);
                    if (!response.ok) return '無法取得地址';
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        return data.results[0].formatted_address;
                    }
                    return '無法解析地址';
                } catch (error) {
                    console.error("Reverse geocoding failed:", error);
                    return '地址解析失敗';
                }
            }
            
            // --- BEGIN MODIFICATION: Debounced address input handler ---
            let geocodeTimeout;
            $(document).on('input', '#add-location-form-mobile #add-address', function() {
                clearTimeout(geocodeTimeout);
                const address = $(this).val();
                if (address && isMobile && tempMarker) {
                    geocodeTimeout = setTimeout(async () => {
                        const data = await geocodeAddress(address);
                        if (data && data.results && data.results.length > 0) {
                            const location = data.results[0].geometry.location;
                            const coords = ol.proj.fromLonLat([location.lng, location.lat]);
                            tempMarker.setPosition(coords);
                            map.getView().animate({ center: coords, zoom: 18 });
                        }
                    }, 800); // 800ms delay
                }
            });
            // --- END MODIFICATION ---

            function handleFormSubmit(e) {
                e.preventDefault();
                const $form = $(e.target);
                const $submitBtn = $form.find('.submit-text').parent();
                const formData = new FormData($form[0]);
                
                const areaRowIndex = $form.find('#edit-area-row-index').val();
                const isAreaUpdate = !!areaRowIndex;
                const isPointUpdate = !!$form.find('#edit-row-index').val();

                if (!isAreaUpdate && !isPointUpdate) {
                     const reasonText = formData.get('blacklistReason').trim();
                     if (!formData.get('blacklistCategory') || !reasonText) {
                     }
                }

                let finalCoords;
                let areaBoundsStr = null;
                const isArea = $form.find('#add-is-area').is(':checked');

                if (isArea) {
                    if (selectedGridCells.size === 0) {
                        showNotification('請在地圖網格上至少選取一個區塊。', 'error');
                        return;
                    }
                    
                    const cellsArray = Array.from(selectedGridCells.entries());
                    let minLon = Infinity, minLat = Infinity;
                    cellsArray.forEach(([key, data]) => {
                        const [lon, lat] = key.split('-').map(Number);
                        if (lon < minLon) minLon = lon;
                        if (lat < minLat) minLat = lat;
                    });

                    const origin = { lon: minLon, lat: minLat };
                    const fillPalette = [], markerPalette = [];
                    const fillMap = new Map(), markerMap = new Map();

                    cellsArray.forEach(([key, data]) => {
                        if (data.fillColor && !fillMap.has(data.fillColor)) {
                            fillMap.set(data.fillColor, fillPalette.length);
                            fillPalette.push(data.fillColor);
                        }
                        if (data.markerColor && !markerMap.has(data.markerColor)) {
                            markerMap.set(data.markerColor, markerPalette.length);
                            markerPalette.push(data.markerColor);
                        }
                    });
                    
                    const palette = { f: fillPalette, m: markerPalette };
                    const markerCharMap = { 'entrance': 'e', 'exit': 'x', 'table': 't', 'parking': 'p' };

                    const compressedCells = cellsArray.map(([key, data]) => {
                        const [lon, lat] = key.split('-').map(Number);
                        const x = Math.round((lon - origin.lon) / GRID_INTERVAL);
                        const y = Math.round((lat - origin.lat) / GRID_INTERVAL);
                        const fillIndex = data.fillColor ? fillMap.get(data.fillColor) : '';
                        const markerChar = data.marker ? markerCharMap[data.marker] : '';
                        const markerColorIndex = data.markerColor ? markerMap.get(data.markerColor) : '';
                        return `${x},${y}:${fillIndex}:${markerChar}:${markerColorIndex}`;
                    });
                    
                    const compressedData = {
                        v: 1,
                        o: [origin.lon.toFixed(GRID_PRECISION), origin.lat.toFixed(GRID_PRECISION)],
                        p: palette,
                        c: compressedCells,
                    };
                    areaBoundsStr = JSON.stringify(compressedData);
                    
                    finalCoords = lockedCenterForEditing || (isMobile ? tempMarker.getPosition() : map.getView().getCenter());


                } else {
                    finalCoords = isMobile ? (tempMarker ? tempMarker.getPosition() : null) : map.getView().getCenter();
                    if (!finalCoords) {
                        showNotification('請在地圖上設定一個位置。', 'error');
                        return;
                    }
                }
                
                $submitBtn.prop('disabled', true).find('.submit-text').addClass('hidden').end().find('.spinner').removeClass('hidden');
                
                const lonLat = ol.proj.toLonLat(finalCoords);
                const rowIndex = $form.find('#edit-row-index').val();
                const originalName = $form.find('#edit-original-name').val();
                
                let action = 'create';
                if (isAreaUpdate) action = 'user_update_area';
                else if (rowIndex) action = 'admin_modify';
                else if (originalName) action = 'update';

                const newData = {
                    action: action,
                    rowIndex: areaRowIndex || rowIndex,
                    originalName: originalName,
                    userEmail: userProfile.email,
                    lineUserId: userProfile.lineUserId,
                    submitterName: currentUserDisplayName || 'N/A',
                    submitterEmail: userProfile.email || 'N/A',
                    adminEmail: userProfile.email,
                    name: formData.get('address'),
                    areaName: formData.get('areaName'),
                    address: formData.get('address'),
                    lon: lonLat[0],
                    lat: lonLat[1],
                    timestamp: new Date().toISOString(),
                    areaBounds: areaBoundsStr,
                };

                if (!isAreaUpdate) {
                    newData.category = formData.get('category');
                    newData.blacklistCategory = formData.get('blacklistCategory');
                    newData.blacklistReason = formData.get('blacklistReason').trim();
                }

                fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(newData) })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success') {
                        showNotification("資料已成功送出！感謝您的貢獻。", 'success');
                        exitAddMode();
                        setTimeout(loadData, 2000);
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                }).catch(error => {
                    showNotification(`送出失敗: ${error.message}`, 'error');
                }).finally(() => {
                    $submitBtn.prop('disabled', false).find('.submit-text').removeClass('hidden').end().find('.spinner').addClass('hidden');
                });
            }


            $('#add-location-form, #add-location-form-mobile').on('submit', handleFormSubmit);

            async function reverseGeocodeForCity(lon, lat) {
                const apiKey = "AIzaSyBa9P8XeaoUPUXPqMm8m6NHawZKFpCePqE";
                try {
                    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}&language=zh-TW&result_type=administrative_area_level_1`);
                    if (!response.ok) throw new Error('Geocoding API response not OK');
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const cityComponent = data.results[0].address_components.find(c => c.types.includes('administrative_area_level_1'));
                        if (cityComponent) {
                            return cityComponent.long_name;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error("Reverse geocoding for city failed:", error);
                    return null;
                }
            }

            async function initializeUserLocation() {
                if (!navigator.geolocation) {
                    showNotification('您的瀏覽器不支援地理定位', 'warning');
                    loadData(); 
                    isLocationKnown = true;
                    if (isLoggedIn) sendJoinMessage();
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        userPositionCoords = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                        map.getView().animate({ center: userPositionCoords, zoom: 16, duration: 1500 });
                        userLocationOverlay.setPosition(userPositionCoords);
                        $('#user-location').removeClass('hidden');

                        const city = await reverseGeocodeForCity(pos.coords.longitude, pos.coords.latitude);
                        currentUserCity = city || '未知區域';
                        isLocationKnown = true;
                        loadData(city);
                        if (isLoggedIn) {
                            sendJoinMessage();
                        }
                    },
                    (err) => {
                        showNotification('無法取得您的位置，聊天室將顯示「未知區域」。', 'warning');
                        isLocationKnown = true;
                        loadData();
                        if (isLoggedIn) {
                            sendJoinMessage();
                        }
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            }
            
            async function checkIfAdmin(email) {
                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=checkAdmin&email=${encodeURIComponent(email)}`);
                    if (!response.ok) throw new Error('Admin check failed');
                    const result = await response.json();
                    
                    if (result.isAdmin) {
                        isAdmin = true;
                        $('#review-btn').removeClass('hidden');
                    } else {
                        isAdmin = false;
                        $('#review-btn').addClass('hidden');
                    }
                } catch (error) {
                    showNotification('無法驗證管理員身份', 'error');
                }
            }
            
            function drawCommunityAreas(areas) {
                areas.forEach(areaData => {
                    if (String(areaData['審核']).toUpperCase() !== 'TRUE') {
                        return;
                    }

                    try {
                        if (!areaData.areaBounds) return;
                        
                        let cellsToDraw;
                        const areaBoundsData = JSON.parse(areaData.areaBounds);

                        if (areaBoundsData.v === 1) {
                            const { o: originCoords, p: palette, c: compressedCells } = areaBoundsData;
                            const origin = { lon: parseFloat(originCoords[0]), lat: parseFloat(originCoords[1]) };
                            const markerReverseMap = { 'e': 'entrance', 'x': 'exit', 't': 'table', 'p': 'parking' };
                            
                            cellsToDraw = compressedCells.map(cellString => {
                                const parts = cellString.split(':');
                                const [x, y] = parts[0].split(',').map(Number);
                                const [fillIndex, markerChar, markerColorIndex] = parts.slice(1);
                                
                                const lon = origin.lon + x * GRID_INTERVAL;
                                const lat = origin.lat + y * GRID_INTERVAL;
                                
                                const cell = { lon, lat };
                                if (fillIndex !== '') cell.fillColor = palette.f[parseInt(fillIndex, 10)];
                                if (markerChar !== '') cell.marker = markerReverseMap[markerChar];
                                if (markerColorIndex !== '') cell.markerColor = palette.m[parseInt(markerColorIndex, 10)];
                                
                                return cell;
                            });

                        } else {
                            cellsToDraw = areaBoundsData;
                        }

                        if (!Array.isArray(cellsToDraw)) return;
                        
                        let minLon = Infinity, maxLon = -Infinity, minLat = Infinity, maxLat = -Infinity;

                        cellsToDraw.forEach(cell => {
                            const { lon, lat, marker, markerColor, fillColor } = cell;
                            const extent = ol.proj.transformExtent(
                                [lon, lat, lon + GRID_INTERVAL, lat + GRID_INTERVAL],
                                'EPSG:4326', 'EPSG:3857'
                            );
                            
                            minLon = Math.min(minLon, lon);
                            maxLon = Math.max(maxLon, lon + GRID_INTERVAL);
                            minLat = Math.min(minLat, lat);
                            maxLat = Math.max(maxLat, lat + GRID_INTERVAL);
                            
                            const cellFeature = new ol.Feature({
                                geometry: ol.geom.Polygon.fromExtent(extent),
                                parentData: areaData
                            });

                            const cellStyleFunction = function(feature, resolution) {
                                const zoom = map.getView().getZoomForResolution(resolution);
                                const styles = [];

                                if (fillColor) {
                                    styles.push(new ol.style.Style({
                                        fill: new ol.style.Fill({ color: fillColor }),
                                    }));
                                }

                                if (marker && zoom >= LABEL_VISIBILITY_ZOOM) {
                                    const markerText = {
                                        'entrance': '入',
                                        'exit': '出',
                                        'table': '桌',
                                        'parking': '停'
                                    }[marker];
                                    styles.push(new ol.style.Style({
                                        text: new ol.style.Text({
                                            text: markerText,
                                            font: 'bold 14px sans-serif',
                                            fill: new ol.style.Fill({ color: markerColor || '#000' }),
                                            backgroundFill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.7)' }),
                                            padding: [2, 2, 2, 2]
                                        })
                                    }));
                                }
                                return styles;
                            };

                            cellFeature.setStyle(cellStyleFunction);
                            areaGridSource.addFeature(cellFeature);
                        });
                        
                        if (areaData.areaName) {
                            const centerLon = minLon + (maxLon - minLon) / 2;
                            const centerLat = minLat + (maxLat - minLat) / 2;
                            const nameFeature = new ol.Feature({
                                geometry: new ol.geom.Point(ol.proj.fromLonLat([centerLon, centerLat])),
                                parentData: areaData
                            });
                             const nameStyleFunction = function(feature, resolution) {
                                const zoom = map.getView().getZoomForResolution(resolution);
                                if (zoom >= LABEL_VISIBILITY_ZOOM) {
                                    return new ol.style.Style({
                                        text: new ol.style.Text({
                                            text: areaData.areaName,
                                            font: 'bold 16px sans-serif',
                                            fill: new ol.style.Fill({ color: '#333' }),
                                            backgroundFill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.8)' }),
                                            padding: [5, 8, 5, 8],
                                            overflow: true
                                        })
                                    });
                                }
                                return null;
                            };
                             nameFeature.setStyle(nameStyleFunction);
                             areaGridSource.addFeature(nameFeature);
                        }

                    } catch(e) {
                        console.error("Failed to parse or draw areaBounds:", areaData.areaBounds, e);
                    }
                });
            }
            
            async function setLoginState(profile) {
                isLoggedIn = true;
                userProfile = profile;
                
                currentUserDisplayName = profile.name;

                $('#google-signin-container').hide();
                $('#add-info').removeClass('hidden').addClass('flex');
                $('#user-name').text(currentUserDisplayName);
                
                const $userPicture = $('#user-picture');
                if (profile.pictureUrl) {
                    $userPicture.attr('src', profile.pictureUrl).removeClass('hidden');
                } else {
                    $userPicture.addClass('hidden').attr('src', '');
                }

                checkIfAdmin(userProfile.email);
                
                if (!isChatHistoryLoaded) {
                    await loadArchivedChatHistory();
                    isChatHistoryLoaded = true;
                }
                
                if (isLocationKnown) {
                    sendJoinMessage();
                }
            }

            function initializeGoogleButton() {
                const $container = $('#google-signin-container');
                if (!isLineApp && window.google && window.google.accounts && window.google.accounts.id) {
                    google.accounts.id.initialize({
                        client_id: '35839698842-b73h9naufqdm7d0j378882k1e6aq6064.apps.googleusercontent.com',
                        callback: handleCredentialResponse
                    });
                    google.accounts.id.renderButton(
                        $container[0],
                        { 
                            type: 'standard',
                            size: 'large',
                            theme: 'outline',
                            text: 'sign_in_with',
                            shape: 'rectangular',
                            logo_alignment: 'left'
                        } 
                    );
                    $container.show();
                } else if (!isLineApp) {
                    setTimeout(initializeGoogleButton, 200);
                }
            }
            
            async function verifyToken() {
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                if (!token) {
                    return false;
                }

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'verify_token', token: token })
                    });
                    const result = await response.json();
                    if (result.status === 'success' && result.user) {
                        setLoginState(result.user);
                        return true;
                    } else {
                        localStorage.removeItem(SESSION_TOKEN_KEY);
                        return false;
                    }
                } catch(error) {
                    console.error('Token 驗證失敗:', error);
                    localStorage.removeItem(SESSION_TOKEN_KEY);
                    return false;
                }
            }

            window.addEventListener('google-signin-success', async (e) => {
                const googleProfile = e.detail;
                 try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'google_login', profile: googleProfile })
                    });
                    const result = await response.json();

                    if (result.status === 'success' && result.token) {
                        localStorage.setItem(SESSION_TOKEN_KEY, result.token);
                        await verifyToken();
                    } else {
                        showNotification('登入失敗，請稍後再試。', 'error');
                    }
                } catch(error) {
                    console.error('Google login process failed:', error);
                    showNotification('登入時發生錯誤。', 'error');
                }
            });

            $(document).on('click', '#edit-nickname-btn', function() {
                const currentName = $('#user-name').text();
                const newName = prompt("請輸入您的新暱稱：", currentName);

                if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                    
                    currentUserDisplayName = newName.trim();
                    $('#user-name').text(currentUserDisplayName);
                    
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const payload = { 
                            type: 'nickname_change',
                            newName: currentUserDisplayName
                        };
                        ws.send(JSON.stringify(payload));
                    }

                    const backendPayload = {
                        action: 'update_nickname',
                        userEmail: userProfile.email,
                        lineUserId: userProfile.lineUserId,
                        newName: currentUserDisplayName
                    };

                    fetch(APPS_SCRIPT_URL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(backendPayload) 
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.status === 'success'){
                           showNotification('暱稱已同步更新！', 'success');
                        } else {
                           throw new Error(data.message || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Nickname sync failed:', error);
                        showNotification(`暱稱同步失敗: ${error.message}`, 'error');
                        $('#user-name').text(currentName);
                        currentUserDisplayName = currentName;
                    });

                } else if (newName === '') {
                    showNotification('暱稱不能為空。', 'error');
                }
            });

            $('#sign-out-btn').on('click', (e) => {
                e.preventDefault();
                
                const token = localStorage.getItem(SESSION_TOKEN_KEY);
                fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'logout', token: token })
                });

                localStorage.removeItem(SESSION_TOKEN_KEY);

                if (window.google && google.accounts && google.accounts.id) {
                    google.accounts.id.disableAutoSelect();
                }
                
                isLoggedIn = false; 
                userProfile = {};
                isAdmin = false;
                currentUserDisplayName = '';

                $('#add-info').removeClass('flex').addClass('hidden');
                $('#review-btn').addClass('hidden');
                
                $('#user-picture').addClass('hidden').attr('src', '');
                $('#google-signin-container').empty(); 
                initializeGoogleButton();

                showNotification('您已成功登出。');
            });
            
            function updateStoreList() {
                const extent = map.getView().calculateExtent(map.getSize());
                const $listContent = $('#store-list-content');
                const activeCategory = $('#store-list-filters .active').data('category');
                $listContent.html('');
                
                let count = 0;
                const featuresInView = vectorSource.getFeaturesInExtent(extent);
                
                const uniqueFeatures = [];
                const featureKeys = new Set();

                clusterSource.forEachFeatureInExtent(extent, function(cluster) {
                    const features = cluster.get('features');
                    features.forEach(function(feature) {
                        if (!featureKeys.has(feature.getId())) {
                            uniqueFeatures.push(feature);
                            featureKeys.add(feature.getId());
                        }
                    });
                });

                uniqueFeatures.forEach(function(feature) {
                    if (count >= 200) return;

                    const category = feature.get('category');
                    if (!activeCategory || category === activeCategory) {
                         const address = feature.get('address');
                         const shortAddress = formatAddress(address);
                         const color = categoryColors[category] || categoryColors['其他'];
                         const listItem = $(`
                            <div class="flex items-center text-sm py-1.5 px-2 cursor-pointer hover:bg-gray-200 rounded-md">
                                <span class="h-2.5 w-2.5 rounded-full mr-2 flex-shrink-0" style="background-color: ${color}"></span>
                                <span class="truncate">${shortAddress}</span>
                            </div>
                         `);
                         listItem.on('click', () => {
                             const coordinates = feature.getGeometry().getCoordinates();
                             map.getView().animate({ center: coordinates, zoom: 18, duration: 800 });
                             setTimeout(() => {
                                 const data = feature.getProperties();
                                 currentFeatureData = data;
                                 
                                 const reportsByFullAddress = new Map();
                                 data.reports.forEach(report => {
                                     const fullAddr = report['地址'];
                                     if (!reportsByFullAddress.has(fullAddr)) {
                                         reportsByFullAddress.set(fullAddr, []);
                                     }
                                     reportsByFullAddress.get(fullAddr).push(report);
                                 });

                                 if (reportsByFullAddress.size > 1) {
                                     renderUnitListPopup(data, reportsByFullAddress);
                                 } else {
                                     renderConsolidatedPopup(data, data.reports);
                                 }
                                 infoOverlay.setPosition(coordinates);
                             }, 200);
                         });
                         $listContent.append(listItem);
                         count++;
                    }
                });
            }

            map.on('moveend', updateStoreList);

            $('#store-list-filters').on('click', '.store-filter-btn', function() {
                const $clickedBtn = $(this);
                const clickedCategory = $clickedBtn.data('category');
                
                $('.store-filter-btn').removeClass('active text-white text-red-600 bg-blue-600').addClass('text-black bg-white');

                $clickedBtn.addClass('active');
                if (clickedCategory === '') {
                    $clickedBtn.removeClass('bg-white text-black').addClass('bg-blue-600 text-white');
                } else {
                    $clickedBtn.removeClass('text-black').addClass('text-red-600');
                }
                
                updateStoreList();
            });
            
            map.getView().on('change:resolution', () => {
                const zoom = map.getView().getZoom();
                if (zoom <= visibilityThreshold) {
                    lineSource.clear();
                }
            });
            
            $('#manage-btn').on('click', async function() {
                await loadData();
                $('#management-modal').removeClass('hidden');
                $('#manage-locations-tab').click();
            });

            $('#close-management-modal').on('click', () => {
                Object.values(managementAreaMaps).forEach(mapInstance => {
                    if (mapInstance) {
                        mapInstance.setTarget(null);
                    }
                });
                managementAreaMaps = {};
                $('#management-modal').addClass('hidden');
            });
            
            $('#manage-locations-tab').on('click', function() {
                $(this).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');
                $('#manage-areas-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');
                $('#management-list-content').removeClass('hidden');
                $('#management-area-content').addClass('hidden');
                loadUserLocations();
            });

            $('#manage-areas-tab').on('click', function() {
                $(this).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');
                $('#manage-locations-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');
                $('#management-area-content').removeClass('hidden');
                $('#management-list-content').addClass('hidden');
                loadUserAreas();
            });
            
            function loadUserLocations() {
                const $listContent = $('#management-list-content');
                $listContent.html('');

                if (!isLoggedIn || (!userProfile.email && !userProfile.lineUserId)) {
                    $listContent.html('<p class="text-gray-500">請先登入以查看您提交的地點。</p>');
                    return;
                }

                const userSubmissions = rawReports.filter(r => 
                    !r.isCommunity && (r.submitterEmail === userProfile.email || r.lineUserId === userProfile.lineUserId)
                );

                if (userSubmissions.length === 0) {
                    $listContent.html('<p class="text-gray-500">您尚未提交任何地點資料。</p>');
                    return;
                }

                userSubmissions.forEach(report => {
                    const isApproved = String(report['審核']).toUpperCase() === 'TRUE';
                    const status = isApproved ?
                        '<span class="text-green-600 font-semibold">已通過審核</span>' :
                        '<span class="text-yellow-600 font-semibold">待審核</span>';

                    const itemHtml = `
                        <div class="border-b py-3 flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${report['地址']}</p>
                                <p class="text-sm text-gray-600">${report['黑名類別']} - ${report['黑名原因']}</p>
                                <p class="text-xs text-gray-500 mt-1">狀態: ${status}</p>
                            </div>
                            <div>
                                <button class="edit-store-btn text-sm text-blue-600 hover:underline mr-4" data-row-index="${report.rowIndex}">修改</button>
                                <button class="delete-store-btn text-sm text-red-600 hover:underline" data-row-index="${report.rowIndex}">刪除</button>
                            </div>
                        </div>
                    `;
                    $listContent.append(itemHtml);
                });
            }
            
            async function loadUserAreas() {
                const $content = $('#management-area-content');
                $content.html('');

                 Object.values(managementAreaMaps).forEach(mapInstance => {
                    if (mapInstance) mapInstance.setTarget(null);
                });
                managementAreaMaps = {};

                if (!isLoggedIn || (!userProfile.email && !userProfile.lineUserId)) {
                    $content.html('<p class="text-gray-500">請先登入以查看您提交的建築。</p>');
                    return;
                }

                const userAreas = rawReports.filter(r => 
                    r.isCommunity && 
                    (
                        r.submitterEmail === userProfile.email || 
                        r.lineUserId === userProfile.lineUserId ||
                        r['製作者'] === userProfile.email ||
                        r['製作者'] === userProfile.lineUserId
                    )
                );

                if (userAreas.length === 0) {
                    $content.html('<p class="text-gray-500">您尚未提交任何建築資料。</p>');
                    return;
                }

                for (const area of userAreas) {
                    const statusKey = String(area['審核']).toUpperCase();
                    let status;
                    if (statusKey === 'TRUE') {
                        status = '<span class="text-green-600 font-semibold">已通過審核</span>';
                    } else if (statusKey === 'REJECT') {
                        status = '<span class="text-red-600 font-semibold">已駁回</span>';
                    } else {
                        status = '<span class="text-yellow-600 font-semibold">待審核</span>';
                    }
                    
                    const addressId = `area-address-${area.rowIndex}`;
                    const mapId = `management-map-${area.rowIndex}`;

                    const areaHtml = $(`
                        <div class="border rounded-lg p-4 mb-4 flex items-center space-x-4">
                            <div id="${mapId}" class="w-24 h-24 bg-gray-100 rounded border border-gray-300 flex-shrink-0"></div>
                            <div class="flex-grow">
                                <h4 class="font-bold text-lg">${area.areaName || '未命名社區'}</h4>
                                <p id="${addressId}" class="text-sm text-gray-600">${area['地址'] || '正在取得地址...'}</p>
                                <div class="mt-2">狀態: ${status}</div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button class="edit-area-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm" data-row-index="${area.rowIndex}">修改</button>
                                <button class="delete-store-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm" data-row-index="${area.rowIndex}">刪除</button>
                            </div>
                        </div>
                    `);
                    
                    $content.append(areaHtml);

                    if (!area['地址'] && area.areaBounds) {
                        try {
                            const areaBoundsData = JSON.parse(area.areaBounds);
                            if (areaBoundsData.v === 1 && areaBoundsData.o) {
                                const [lon, lat] = areaBoundsData.o;
                                const fetchedAddress = await getAddressFromCoords(parseFloat(lon), parseFloat(lat));
                                $(`#${addressId}`).text(fetchedAddress);
                            }
                        } catch (e) {
                             $(`#${addressId}`).text('地址格式錯誤');
                             console.error("Could not parse areaBounds to get address:", e);
                        }
                    }
                    
                    setTimeout(() => {
                       const mapInstance = renderAreaOnMap(mapId, area.areaBounds);
                       if (mapInstance) {
                           managementAreaMaps[area.rowIndex] = mapInstance;
                       }
                    }, 0);
                }
            }

            $('#management-list-content').on('click', '.edit-store-btn', function() {
                const rowIndex = $(this).data('row-index');
                const reportToEdit = rawReports.find(r => r.rowIndex == rowIndex && !r.isCommunity);
                if (reportToEdit) openEditModalForUser(reportToEdit);
                else showNotification('找不到地點資料，可能已被刪除或更新。', 'error');
            });
            
            $('#management-area-content').on('click', '.edit-area-btn', function() {
                const rowIndex = $(this).data('row-index');
                const reportToEdit = rawReports.find(r => r.rowIndex == rowIndex && r.isCommunity);
                if (reportToEdit) openEditModalForUser(reportToEdit);
                else showNotification('找不到建築資料，可能已被刪除或更新。', 'error');
            });

            $('#management-list-content, #management-area-content').on('click', '.delete-store-btn', function() {
                const rowIndex = $(this).data('row-index');
                if (confirm('確定要刪除這筆您提交的資料嗎？此操作將無法復原。')) {
                    showNotification('正在刪除...');
                    const payload = {
                        action: 'user_delete',
                        rowIndex: rowIndex,
                        userEmail: userProfile.email,
                        lineUserId: userProfile.lineUserId
                    };
                    fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        showNotification("資料已成功刪除！", 'success');
                        $('#management-modal').addClass('hidden');
                        setTimeout(loadData, 2000);
                    }).catch(error => showNotification('刪除失敗，請稍後再試。', 'error'));
                }
            });

            $('#review-btn').on('click', async function() {
                await loadData();
                $('#review-modal').removeClass('hidden');
                loadReviewData('pending');
                $('#pending-tab').addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');
                $('#approved-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');
            });

            $('#close-review-modal').on('click', () => {
                if (reviewMapInstance) {
                    reviewMapInstance.setTarget(null);
                    reviewMapInstance = null;
                }
                $('#review-modal').addClass('hidden');
            });
            
            $('#pending-tab').on('click', function() {
                $(this).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                $('#approved-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                loadReviewData('pending');
            });

            $('#approved-tab').on('click', function() {
                $(this).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                $('#pending-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                loadReviewData('approved');
            });
            
            $('#review-modal').on('click', '#review-refresh-btn', async function() {
                showNotification('正在更新列表...', 'info');
                await loadData();
                const activeTab = $('#pending-tab').hasClass('border-indigo-500') ? 'pending' : 'approved';
                loadReviewData(activeTab);
            });

        function loadReviewData(status = 'pending') {
                const $listPanel = $('#review-list-panel');
                const $detailPanel = $('#review-detail-panel');
                $listPanel.html('');
                $detailPanel.html('<p class="text-gray-500">請從左側列表選擇一個地點以查看詳細資訊。</p>');

                const reportsToReview = rawReports.filter(report => {
                    const currentStatus = String(report['審核']).toUpperCase();
                    if (status === 'pending') {
                        return currentStatus !== 'TRUE' && currentStatus !== 'REJECT';
                    } else {
                        return currentStatus === 'TRUE' || currentStatus === 'REJECT';
                    }
                });

                if (reportsToReview.length === 0) {
                    $listPanel.html(`<p class="p-4 text-sm text-gray-500">沒有${status === 'pending' ? '待審核' : '已審核或已駁回'}的項目。</p>`);
                    return;
                }

                reportsToReview.forEach(report => {
                    const listItem = $(`
                        <div class="p-4 border-b cursor-pointer hover:bg-gray-100 review-item" data-row-index="${report.rowIndex}" data-is-community="${!!report.isCommunity}">
                            <p class="font-semibold text-gray-800">${report.areaName || report['地址']}</p>
                            <p class="text-sm text-gray-600 truncate">${report['黑名原因'] || '無原因 (社區項目)'}</p>
                            <p class="text-xs text-gray-400 mt-1">提交者: ${report.submitterEmail || report.submitterLineId || report['製作者'] ||'N/A'}</p>
                        </div>
                    `);
                    $listPanel.append(listItem);
                });
            }

            $('#review-list-panel').on('click', '.review-item', function() {
                $('.review-item').removeClass('bg-indigo-50');
                $(this).addClass('bg-indigo-50');
                const rowIndex = $(this).data('row-index');
                const isCommunity = $(this).data('is-community');
                
                const report = rawReports.find(r => r.rowIndex == rowIndex && !!r.isCommunity === isCommunity);

                if (report) {
                    displayReviewDetails(report);
                }
            });

            function displayReviewDetails(report) {
                const $detailPanel = $('#review-detail-panel');
                const submissionDate = report.timestamp ? 
                    new Date(report.timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : 
                    '日期不明';

                if (report.isCommunity) {
                    const detailHtml = `
                        <div id="review-map-container" class="relative w-full h-64 bg-gray-200 mb-4 rounded-lg overflow-hidden">
                            <div id="review-map" class="w-full h-full"></div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <h3 class="text-xl font-bold text-gray-900">${report.areaName || '未命名社區'}</h3>
                            <hr class="my-2">
                            <p><strong>座標:</strong> ${parseFloat(report['經度']).toFixed(5)}, ${parseFloat(report['緯度']).toFixed(5)}</p>
                            <p><strong>提交者:</strong> ${report.submitterName || 'N/A'} (${report.submitterEmail || report.submitterLineId || report['製作者'] || 'N/A'})</p>
                            <p><strong>提交時間:</strong> ${submissionDate}</p>
                            <p><strong>試算表分頁名稱:</strong> 社區列表</p>
                            <p><strong>試算表列數:</strong> ${report.rowIndex}</p>
                        </div>
                        <div class="mt-6 flex space-x-4">
                            <button class="admin-action-btn flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700" data-action="approve" data-row-index="${report.rowIndex}" data-is-community="true">通過</button>
                            <button class="admin-action-btn flex-1 bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700" data-action="reject" data-row-index="${report.rowIndex}" data-is-community="true">駁回</button>
                        </div>
                    `;
                    $detailPanel.html(detailHtml);

                    // Initialize review map
                    if (reviewMapInstance) {
                        reviewMapInstance.setTarget(null);
                        reviewMapInstance = null;
                    }
                    
                    setTimeout(() => {
                        reviewMapInstance = renderAreaOnMap('review-map', report.areaBounds);
                    }, 0);

                } else {
                     const detailHtml = `
                        <div class="space-y-3 text-sm">
                            <h3 class="text-xl font-bold text-gray-900">${report.areaName || report['地址']}</h3>
                            <p class="font-semibold" style="color: ${categoryColors[report['分類']] || categoryColors['其他']}">${report['分類']}</p>
                            <hr>
                            <p><strong>黑名類別:</strong> ${report['黑名類別']}</p>
                            <p><strong>黑名原因:</strong></p>
                            <p class="whitespace-pre-wrap bg-gray-50 p-2 rounded">${report['黑名原因']}</p>
                            <hr>
                            <p><strong>座標:</strong> ${parseFloat(report['經度']).toFixed(5)}, ${parseFloat(report['緯度']).toFixed(5)}</p>
                            <p><strong>提交者:</strong> ${report.submitterName || 'N/A'} (${report.submitterEmail || report.submitterLineId || 'N/A'})</p>
                            <p><strong>提交時間:</strong> ${submissionDate}</p>
                             <p><strong>試算表分頁名稱:</strong> 資料回報</p>
                            <p><strong>試算表列數:</strong> ${report.rowIndex}</p>
                        </div>
                        <div class="mt-6 flex space-x-4">
                            <button class="admin-action-btn flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700" data-action="approve" data-row-index="${report.rowIndex}" data-is-community="false">通過</button>
                            <button class="admin-action-btn flex-1 bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700" data-action="reject" data-row-index="${report.rowIndex}" data-is-community="false">駁回</button>
                            <button class="admin-action-btn flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700" data-action="delete" data-row-index="${report.rowIndex}" data-is-community="false">刪除</button>
                        </div>
                    `;
                    $detailPanel.html(detailHtml);
                }
            }
            
            $('#review-detail-panel').on('click', '.admin-action-btn', function() {
                const action = $(this).data('action');
                const rowIndex = $(this).data('row-index');
                const isCommunity = $(this).data('is-community');
                
                if (action === 'delete') {
                    if (!confirm('確定要刪除這筆資料嗎？此操作將無法復原。')) {
                        return;
                    }
                }
                sendAdminAction(action, rowIndex, isCommunity);
            });
            
            function sendAdminAction(action, rowIndex, isCommunity) {
                showNotification(`正在執行操作...`);

                const payload = {
                    action: action,
                    rowIndex: rowIndex,
                    isCommunity: isCommunity,
                    adminEmail: userProfile.email
                };

                fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success') {
                         showNotification("操作成功！資料將在幾分鐘後更新。", 'success');
                         const activeTab = $('#pending-tab').hasClass('border-indigo-500') ? 'pending' : 'approved';
                         loadReviewData(activeTab);
                         $detailPanel.html('<p class="text-gray-500">操作完成，請從左側選擇下一個項目。</p>')
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                }).catch(error => {
                    showNotification(`操作失敗: ${error.message}`, 'error');
                });
            }

            async function openEditModalForUser(report) {
                const forms = [$('#add-location-form'), $('#add-location-form-mobile')];
                const isAreaEdit = !!report.isCommunity;
                
                areaBoundsForEditing = null;

                forms.forEach($f => {
                    $f[0].reset();
                    $f.find('#add-is-area').prop('checked', false);
                    $f.find('#edit-row-index').val(isAreaEdit ? '' : report.rowIndex);
                    $f.find('#edit-area-row-index').val(isAreaEdit ? report.rowIndex : '');
                    $f.find('#edit-original-name').val(report['地址']);
                    $f.find('#add-address').val(report['地址']);
                    $f.find('#add-area-name').val(report['areaName'] || '');
                    $f.find('#add-category').val(report['分類']);
                    $f.find('#add-blacklist-category').val(report['黑名類別']);
                    $f.find('#add-blacklist-reason').val(report['黑名原因']);
                    $f.closest('div[id^="add-location-modal"]').find('h2').text(isAreaEdit ? '修改建築' : '修改地點');
                    
                    const $categoryDiv = $f.find('#add-category').closest('div');
                    const $blacklistCatDiv = $f.find('#add-blacklist-category').closest('div');
                    const $blacklistReasonDiv = $f.find('#add-blacklist-reason').closest('div');
                    
                    if (isAreaEdit) {
                        $categoryDiv.hide();
                        $blacklistCatDiv.hide();
                        $blacklistReasonDiv.hide();
                        $blacklistCatDiv.find('select').prop('required', false);
                        $categoryDiv.find('select').prop('required', false);
                        $blacklistReasonDiv.find('textarea').prop('required', false);
                        $blacklistCatDiv.find('label').find('span').hide();
                        $blacklistReasonDiv.find('label').find('span').hide();
                    } else {
                        $categoryDiv.show();
                        $blacklistCatDiv.show();
                        $blacklistReasonDiv.show();
                        $blacklistCatDiv.find('select').prop('required', true);
                        $blacklistReasonDiv.find('textarea').prop('required', true);
                        $blacklistCatDiv.find('label').find('span').show();
                        $blacklistReasonDiv.find('label').find('span').show();
                    }
                });

                $('#management-modal').addClass('hidden');
                
                const coordinate = ol.proj.fromLonLat([parseFloat(report['經度']), parseFloat(report['緯度'])]);
                
                if (isAreaEdit) {
                    areaBoundsForEditing = report.areaBounds;

                    if (!report['地址'] && report.areaBounds) {
                        try {
                            const areaBoundsData = JSON.parse(report.areaBounds);
                            if (areaBoundsData.v === 1 && areaBoundsData.o) {
                                const [lon, lat] = areaBoundsData.o;
                                const address = await getAddressFromCoords(parseFloat(lon), parseFloat(lat));
                                forms.forEach($f => $f.find('#add-address').val(address));
                            }
                        } catch(e) { console.error("Could not parse areaBounds for address", e); }
                    }

                    areaGridSource.clear();
                    
                    if (isMobile) {
                        enterMobilePlacementMode(coordinate, report.areaBounds);
                        const formContent = $('#add-location-form > .px-6').clone(true, true);
                        $('#add-location-form-mobile > .px-6').replaceWith(formContent);
                        $('#add-location-form-mobile').find('#add-category, #add-blacklist-category, #add-blacklist-reason').closest('div').hide();
                        $('#add-location-modal-mobile').removeClass('hidden');
                        $('#complete-placement-btn').addClass('hidden');
                    } else {
                        enterDesktopAddMode(coordinate, report.areaBounds);
                    }
                } else {
                    if (isMobile) {
                        enterMobilePlacementMode(coordinate);
                        $('#add-location-modal-mobile').removeClass('hidden');
                        $('#complete-placement-btn').addClass('hidden');
                    } else {
                         enterDesktopAddMode(coordinate);
                    }
                }
            }
            
            async function main() {
                const initializeApp = async () => {
                    setupGridToolbar();
                    initializeChat();
                    
                    const lineLoginLiffUrl = 'https://liff.line.me/2008020548-lVYKgg0B';
                    
                    loadUserVotes();
                    initializeUserLocation();

                    const isTokenLoggedIn = await verifyToken();

                    if (isLineApp && !isTokenLoggedIn) {
                        window.location.href = lineLoginLiffUrl;
                        return;
                    } else if (!isLineApp && !isTokenLoggedIn) {
                        initializeGoogleButton();
                        if (loginCheckInterval) clearInterval(loginCheckInterval);
                        let attempts = 0;
                        loginCheckInterval = setInterval(async () => {
                            attempts++;
                            if (!isLoggedIn) {
                                const success = await verifyToken();
                                if (success || attempts > 30) {
                                    clearInterval(loginCheckInterval);
                                }
                            } else {
                                     clearInterval(loginCheckInterval);
                            }
                        }, 1000);
                    }

                   $('#open-chat-btn').on('click', () => {
                        $('#chat-modal').removeClass('hidden');
                        unreadChatCount = 0;
                        $('#chat-unread-badge').addClass('hidden').text('');
                        const $chatWindow = $('#chat-messages');
                        setTimeout(() => $chatWindow.scrollTop($chatWindow[0].scrollHeight), 0);
                   });
                    $('#close-chat-modal').on('click', () => $('#chat-modal').addClass('hidden'));
                    $('#send-chat-btn').on('click', sendChatMessage);
                    $('#chat-input').on('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            sendChatMessage();
                        }
                    });

                    $('#hide-system-msgs-checkbox').on('change', function() {
                        $('#chat-messages').toggleClass('hide-system-messages', $(this).is(':checked'));
                    });

                    let longPressTimer;

                    $('#chat-messages').on('contextmenu', '.chat-message-item', function(e) {
                        e.preventDefault();
                        handleContextMenu(this, e.pageX, e.pageY);
                    }).on('touchstart', '.chat-message-item', function(e) {
                        const targetElement = this;
                        longPressTimer = setTimeout(() => {
                            const touch = e.touches[0];
                            handleContextMenu(targetElement, touch.pageX, touch.pageY);
                        }, 500);
                    }).on('touchend', '.chat-message-item', function() {
                        clearTimeout(longPressTimer);
                    }).on('touchmove', '.chat-message-item', function() {
                        clearTimeout(longPressTimer);
                    });

                    $(document).on('click', function() {
                        $('#chat-context-menu').addClass('hidden');
                    });
                    
                    $('#mute-user-form').on('submit', function(e) {
                        e.preventDefault();
                        const days = parseInt($('#mute-days').val(), 10) || 0;
                        const minutes = parseInt($('#mute-minutes').val(), 10) || 0;
                        
                        if (days === 0 && minutes === 0) {
                            showNotification('請設定有效的禁言時間。', 'warning');
                            return;
                        }
                        
                        const duration = `${days}d${minutes}m`;
                        
                        const payload = {
                            action: 'muteUser',
                            adminEmail: userProfile.email,
                            targetUserId: contextMenuTarget.userId,
                            targetUserName: contextMenuTarget.userName,
                            duration: duration
                        };
                        
                        showNotification(`正在禁言 ${contextMenuTarget.userName}...`, 'info');

                        fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(result => {
                            if (result.status === 'success') {
                                showNotification(`${contextMenuTarget.userName} 已被禁言。`, 'success');
                                $('#mute-user-modal').addClass('hidden');
                            } else {
                                throw new Error(result.message || 'Unknown error');
                            }
                        })
                        .catch(error => {
                            showNotification(`禁言失敗: ${error.message}`, 'error');
                        });
                    });

                    $('#cancel-mute-btn').on('click', () => {
                        $('#mute-user-modal').addClass('hidden');
                    });
                    
                    $('#context-mute-user').on('click', function(e) {
                        e.preventDefault();
                        $('#chat-context-menu').addClass('hidden');
                        if (contextMenuTarget.userId) {
                            $('#mute-user-name').text(contextMenuTarget.userName);
                            $('#mute-user-modal').removeClass('hidden');
                        }
                    });
                };

                function handleContextMenu(element, x, y) {
                    const $el = $(element);
                    const userId = $el.data('user-id');
                    const userName = $el.data('user-name');

                    if (!userId || userId === (userProfile.email || userProfile.lineUserId)) {
                        return;
                    }
                    
                    contextMenuTarget = { userId, userName };
                    
                    const $menu = $('#chat-context-menu');
                    
                    if (isAdmin) {
                        $('#context-mute-user').show();
                    } else {
                        $('#context-mute-user').hide();
                    }
                    
                    $menu.css({
                        top: `${y}px`,
                        left: `${x}px`,
                    }).removeClass('hidden');
                }
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeApp);
                } else {
                    initializeApp();
                }
            }

            main();
        };
    </script>
</body>
</html>
